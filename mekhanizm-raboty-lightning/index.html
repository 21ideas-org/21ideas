<!doctype html><html lang=ru-RU dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Пояснение механизма работы Lightning Network."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta name=lightning content="21ideas@getalby.com"><meta property="og:title" content="Механизм работы Lightning Network"><meta property="og:description" content="Пояснение механизма работы Lightning Network."><meta property="og:type" content="article"><meta property="og:url" content="https://21ideas.org/mekhanizm-raboty-lightning/"><meta property="article:section" content="docs"><meta property="article:published_time" content="2018-01-30T00:00:00+00:00"><meta property="article:modified_time" content="2023-10-22T12:39:58+03:00"><title>Механизм работы Lightning Network | 21ideas</title><link rel=manifest href=/manifest.json><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon media="(prefers-color-scheme: dark)" sizes=180x180 href=/apple-touch-icon-dark.png><link rel=icon type=image/png media="(prefers-color-scheme: dark)" sizes=32x32 href=/favicon-32x32-dark.png><link rel=icon type=image/png media="(prefers-color-scheme: dark)" sizes=16x16 href=/favicon-16x16-dark.png><link rel=stylesheet href=/book.min.a043b8b27f2a92d2d98e2ff73210e31a80ffe4421e4345430ac8fff976f8e63d.css integrity="sha256-oEO4sn8qktLZji/3MhDjGoD/5EIeQ0VDCsj/+Xb45j0=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/ru.search.min.7c9f5580d999424f101ad22481dee14dbb83ca98fd262adc60a405a2d6ab4e87.js integrity="sha256-fJ9VgNmZQk8QGtIkgd7hTbuDypj9JircYKQFotarToc=" crossorigin=anonymous></script>
<script type=text/javascript src=https://unpkg.com/zapthreads@0.2.0/dist/zapthreads.iife.js></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><picture><source srcset=/svg/logo_white.svg media="(prefers-color-scheme: dark)"><img src=/svg/logo_black.svg alt=Logo></picture>
<span>21ideas</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Поиск aria-label=Поиск maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><input type=checkbox id=section-512cd8dd047d9194f8b56568c3c961b4 class=toggle>
<label for=section-512cd8dd047d9194f8b56568c3c961b4 class="flex justify-between"><a href=/start/>Старт</a></label><ul><li><a href=/start/start/>Что такое Биткоин?</a></li><li><a href=/start/guide/>Используем биткоин</a></li><li><a href=/kurs/>Биткоин от А до Я</a></li><li><a href=/razrushaem-mify-o-bitcoin/>Разрушаем мифы о Биткоине</a></li><li><a href=/shitcoin-casino/>Не играйте в щиткоин-казино</a></li></ul></li><li><input type=checkbox id=section-4f53cbff6ac5b0f9cfca5f1f9f3b991c class=toggle checked>
<label for=section-4f53cbff6ac5b0f9cfca5f1f9f3b991c class="flex justify-between"><a href=/theory/>Теория</a></label><ul><li><input type=checkbox id=section-c4ddad175f26bb1d35909363eff62296 class=toggle>
<label for=section-c4ddad175f26bb1d35909363eff62296 class="flex justify-between"><a href=/economics/>Экономика</a></label><ul><li><input type=checkbox id=section-a51542c01e6fb6da0be0947ec8232131 class=toggle>
<label for=section-a51542c01e6fb6da0be0947ec8232131 class="flex justify-between"><a href=/pzv/>Постепенно, затем внезапно</a></label><ul><li><a href=/pzv/postepenno-zatem-vnezapno/>Введение</a></li><li><a href=/pzv/bitkoin-nelzya-skopirovat/>Биткоин нельзя скопировать</a></li><li><a href=/pzv/bitkoin-ne-slishkom-volatilen/>Биткоин не слишком волатилен</a></li><li><a href=/pzv/bitkoin-ne-tratit-energiyu-zrya/>Биткоин не тратит энергию зря</a></li><li><a href=/pzv/bitkoin-ne-slishkom-medlennyj/>Биткоин не слишком медленный</a></li><li><a href=/pzv/bitkoin-eto-ispravit/>Биткоин это исправит</a></li><li><a href=/pzv/bitkoin-ne-blokchejn/>Биткоин, не блокчейн</a></li><li><a href=/pzv/bitkoin-nichem-ne-podkreplen/>Биткоин ничем не подкреплен?</a></li><li><a href=/pzv/bitkoin-ne-finansovaya-piramida/>Биткоин — не финансовая пирамида</a></li><li><a href=/pzv/bitkoin-ne-mozhet-byt-zabanen/>Биткоин не может быть забанен</a></li><li><a href=/pzv/bitkoin-ne-dlya-prestupnikov/>Биткоин не для преступников</a></li><li><a href=/pzv/bitkoin-obescenivaet-ostalnye-dengi/>Биткоин обесценивает остальные деньги</a></li><li><a href=/pzv/bitkoin-zov-k-edineniyu/>Биткоин — зов к единению</a></li><li><a href=/pzv/bitkoin-eto-zdravyj-smysl/>Биткоин — это здравый смысл</a></li><li><a href=/pzv/bitkoin-velikaya-definancializaciya/>Биткоин — великая дефинанcиализация</a></li></ul></li><li><input type=checkbox id=section-f77a8c77e4ac28a47562f512f5567bcb class=toggle>
<label for=section-f77a8c77e4ac28a47562f512f5567bcb class="flex justify-between"><a href=/sb/>Становление Биткоина</a></label><ul><li><a href=/sb/stanovlenie-intro/>Становление Биткоина: Краткий обзор истории от пещерных людей до сети lightning</a></li><li><a href=/sb/stanovlenie-1/>Становление Биткоина Часть 1. О времени</a></li><li><a href=/sb/stanovlenie-2/>Становление Биткоина Часть 2. О людях</a></li><li><a href=/sb/stanovlenie-3/>Становление Биткоина Часть 3. Знакомьтесь: деньги</a></li><li><a href=/sb/stanovlenie-4/>Становление Биткоина Часть 4. Поворот не туда</a></li><li><a href=/sb/stanovlenie-5/>Становление Биткоина Часть 5. Цифровая редкость</a></li><li><a href=/sb/stanovlenie-6/>Становление Биткоина Часть 6. Цифровые контракты</a></li><li><a href=/sb/stanovlenie-7/>Становление Биткоина Часть 7: Недостающие части головоломки</a></li></ul></li><li><a href=/bitkoin-ne-vredit-okruzhayushej-srede/>Биткоин и окружающая среда</a></li><li><a href=/sem-setevyh-effektov-bitkoina/>Семь сетевых эффектов Биткоина</a></li><li><a href=/hozyaeva-i-raby-deneg/>Хозяева и рабы денег</a></li><li><a href=/strukturnaya-perestrojka/>Структурная перестройка</a></li><li><a href=/v-zashchitu-deflyacii/>В защиту дефляции</a></li><li><a href=/sravnenie-monetarnyh-standartov/>Сравнение монетарных стандартов</a></li><li><a href=/negativnye-effekty-neftedollara/>Негативные внешние эффекты нефтедоллара</a></li><li><a href=/raskoshelivaemsya/>Раскошеливаемся (Shelling Out): Происхождение денег</a></li><li><a href=/bitcoin-i-ritmy-istorii/>Биткоин и ритмы истории</a></li><li><a href=/bitcoin-i-internet-cikly-hopfa/>Биткоин и интернет-циклы Хопфа</a></li><li><a href=/dengi-blokchejny-i-socialnaya-masshtabiruemost/>Деньги, блокчейны и социальная масштабируемость</a></li><li><a href=/chto-takoe-dengi/>Что такое деньги</a></li><li><a href=/vyzhivaet-silnejshij/>Выживает сильнейший</a></li><li><a href=/strategiya-dca/>Стратегия DCA</a></li><li><a href=/pochemu-21-million/>Почему 21 миллион?</a></li><li><a href=/jevons_paradox/>Парадокс Джевонса: Обратная истина</a></li></ul></li><li><input type=checkbox id=section-e83ea293497a2ab861101ccfc99a8ecc class=toggle>
<label for=section-e83ea293497a2ab861101ccfc99a8ecc class="flex justify-between"><a href=/security/>Безопасность</a></label><ul><li><a href=/kak-hranit-kljuchi/>Биткоин-кошельки. Зачем и как хранить свои приватные ключи</a></li><li><a href=/multisig-1/>Мультисиг. Часть I</a></li><li><a href=/multisig-2/>Мультисиг. Часть II: Отдельные ключи – основа мультиподписи</a></li><li><a href=/passphrase/>Насколько надежна ваша парольная фраза?</a></li></ul></li><li><input type=checkbox id=section-e9552bdc5e196adcf41f88d9180bebda class=toggle>
<label for=section-e9552bdc5e196adcf41f88d9180bebda class="flex justify-between"><a href=/privacy/>Приватность</a></label><ul><li><a href=/privacy/luchshie-praktiki/>Как сохранить приватность?</a></li><li><a href=/privacy/no-kyc/>Никаких KYC, берегите персональные данные</a></li><li><a href=/privacy/coinjoin/>Обзор процесса CoinJoin</a></li><li><a href=/privatnost-v-seti-bitcoin/>Приватность в сети Биткоин</a></li><li><a href=/bitcoin-stanovitsya-kriticheski-vazhnym/>Биткоин становится критически важным</a></li><li><a href=/bip47-ili-gadkij-utenok/>BIP47, или гадкий утенок</a></li></ul></li><li><input type=checkbox id=section-e49feff8bdc4c8d9840548f297831fbc class=toggle>
<label for=section-e49feff8bdc4c8d9840548f297831fbc class="flex justify-between"><a href=/protocol/>Протокол</a></label><ul><li><a href=/kto-kontroliruet-bitkoin-kor/>Кто контролирует Bitcoin Core?</a></li><li><a href=/vechnaja-borba/>Вечная борьба Биткоина</a></li><li><a href=/ob-udobstve-vzaimodejstvija-s-bitcoinom/>Об удобстве взаимодействия с Биткоином</a></li><li><a href=/bitcoin-zoloto-2-0/>Биткоин: цифровое золото или пиринговая наличность?</a></li><li><a href=/upravlenie-bitcoin/>Управление Биткоином</a></li><li><a href=/doverennye-tretyi-storony/>Доверенные третьи стороны — это бреши в системе безопасности</a></li><li><a href=/21-million-ne-podlezhit-obsuzhdeniyu/>21 миллион не подлежит обсуждению</a></li><li><a href=/proof-of-work/>Proof of Work: доказательство проделанной работы</a></li><li><a href=/proof-of-stake%E2%80%93eto-skam/>Proof of Stake – это скам</a></li><li><a href=/byl-li-satoshi-zhadnym-majnerom/>Был ли Сатоши жадным майнером?</a></li><li><a href=/taproot/>Что такое Taproot</a></li><li><a href=/bomby-slozhnosti-ethereum/>Бомбы сложности Ethereum</a></li><li><a href=/rgb/>Разбирая протокол RGB</a></li><li><a href=/difficulty/>О корректировке сложности майнинга</a></li></ul></li><li><input type=checkbox id=section-8509d6019544d659ccbc67af32e91aea class=toggle>
<label for=section-8509d6019544d659ccbc67af32e91aea class="flex justify-between"><a href=/history/>История</a></label><ul><li><input type=checkbox id=section-51bacf4bb315fc63174fdbbc90ffb95d class=toggle>
<label for=section-51bacf4bb315fc63174fdbbc90ffb95d class="flex justify-between"><a href=/gf/>Генезис-файлы</a></label><ul><li><a href=/gf/genesis-intro/>Пролог</a></li><li><a href=/gf/genesis-1/>Часть I: eCash Дэвида Чаума и зарождение мечты шифропанков</a></li><li><a href=/gf/genesis-2/>Часть II: Hashcash или как Адам Бэк разработал сердце Биткоина</a></li><li><a href=/gf/genesis-3/>Часть III: Если у Биткоина был прототип, то это были b-money Вэя Дая</a></li><li><a href=/gf/genesis-4/>Часть IV: Создавая Bit Gold, Сабо был в двух шагах от изобретения Биткоина</a></li><li><a href=/gf/genesis-5/>Часть V: Как поиски цифровой наличности привели Хэла Финни к созданию RPOW (и не только)</a></li></ul></li><li><a href=/hal-finney/>Хэл Финни — жизнь и смерть легенды движения шифропанков</a></li><li><a href=/bitcoin-reformaciya/>Биткоин-Реформация</a></li></ul></li><li><input type=checkbox id=section-042f7e1a0906e66d4ceaeeb231b37175 class=toggle>
<label for=section-042f7e1a0906e66d4ceaeeb231b37175 class="flex justify-between"><a href=/philosophy/>Философия</a></label><ul><li><input type=checkbox id=section-bd1e0d829bfcab27e0824c72f1ea40a3 class=toggle>
<label for=section-bd1e0d829bfcab27e0824c72f1ea40a3 class="flex justify-between"><a href=/chemu-ya-nauchilsya-u-bitcoina/>Чему я научился у Биткоина?</a></label><ul><li><a href=/chemu-ya-nauchilsya-u-bitcoina/filosofskie-uroki-bitcoina/>Часть1. Философские уроки Биткоина</a></li></ul></li><li><a href=/ne-shitcoin/>Биткоин, не щиткоин</a></li><li><a href=/neotemlemye-prava-sobstvennosti/>Неотъемлемые права собственности</a></li><li><a href=/manifest-kriptoanarhista/>Манифест криптоанархиста</a></li><li><a href=/manifest-shifropanka/>Манифест шифропанка</a></li><li><a href=/tyulpannaya-lihoradka/>Биткоин — современная голландская тюльпанная лихорадка?</a></li><li><a href=/vse-moshenniki/>Все — мошенники</a></li><li><a href=/svoboda-cennosti/>Свобода ценности</a></li><li><a href=/bitcoin-meme/>Биткоин — единственный реальный мем</a></li><li><a href=/nol-i-bitcoin/>Ноль и Биткоин</a></li><li><a href=/crypto-bro/>Дорогие крипто- и фиат-бро</a></li><li><a href=/boremsya-s-poddelnymi-bitcoin/>Боремся с поддельными биткоинами</a></li><li><a href=/bit%D1%81oin-eto-micelij/>Биткоин — это мицелий</a></li><li><a href=/pochemu-bitcoin-zhivoj-organizm/>Доказательство жизни. Почему Биткоин — живой организм</a></li><li><a href=/samaya-mirnaya-revolyuciya/>Самая мирная революция</a></li><li><a href=/o-bitcoin-vselennoj/>О Биткоин-вселенной</a></li><li><a href=/bitcoin-dissidenty/>Биткоин-диссиденты</a></li><li><a href=/bitcoin-svoboda/>Биткоин = свобода</a></li><li><a href=/mify-o-halvinge/>Мифы о Биткоин-халвинге</a></li></ul></li><li><input type=checkbox id=section-66beb9b5ed04619b43509a5a9298b3a2 class=toggle>
<label for=section-66beb9b5ed04619b43509a5a9298b3a2 class="flex justify-between"><a href=/future/>Будущее</a></label><ul><li><input type=checkbox id=section-df24c55b3b01a044f159006399dd3f62 class=toggle>
<label for=section-df24c55b3b01a044f159006399dd3f62 class="flex justify-between"><a href=/ba/>Биткоин-астрономия</a></label><ul><li><a href=/ba/1/>Постгипербиткоинизация</a></li><li><a href=/ba/2/>Миллион крошечных миров</a></li><li><a href=/ba/3/>Первый контакт</a></li></ul></li><li><a href=/ej-bitcoin-pritormozi/>Эй, Биткоин, притормози</a></li><li><a href=/apokalipsis/>Сможет ли Биткоин пережить апокалипсис?</a></li><li><a href=/bitcoin-i-teplovaya-energiya-okeanov/>Биткоин и тепловая энергия океанов</a></li></ul></li><li><input type=checkbox id=section-a71a3aee31fa8f939d269196bdc16bfd class=toggle checked>
<label for=section-a71a3aee31fa8f939d269196bdc16bfd class="flex justify-between"><a href=/lightning/>Лайтнинг</a></label><ul><li><a href=/chto-takoe-laitning/>Что такое Лайтнинг?</a></li><li><a href=/lajtning-adresa/>Лайтнинг-адреса</a></li><li><a href=/privatnost-v-lajtning/>Приватность в сети Lightning</a></li><li><a href=/likvidnost-v-lajtning/>Руководство по управлению ликвидностью в сети Lightning</a></li><li><a href=/centralizovanna-li-set-lightning/>Централизованна ли сеть Lightning?</a></li><li><a href=/mekhanizm-raboty-lightning/ class=active>Механизм работы Lightning Network</a></li><li><a href=/problema-vhodyashchej-likvidnosti/>Решение проблемы входящей ликвидности</a></li></ul></li></ul></li><li><input type=checkbox id=section-a6b5e5f811434cb992fdebac0e1d7718 class=toggle>
<label for=section-a6b5e5f811434cb992fdebac0e1d7718 class="flex justify-between"><a href=/practice/>Практика</a></label><ul><li><input type=checkbox id=section-5a7a56ff2c706814b0747555f55b45b2 class=toggle>
<label for=section-5a7a56ff2c706814b0747555f55b45b2 class="flex justify-between"><a href=/practice/buy/>Покупка</a></label><ul><li><a href=/hodl-hodl/>Покупка биткоина без KYC на Hodl Hodl</a></li></ul></li><li><input type=checkbox id=section-a2a499e8fa40193bb85003cabaff5d49 class=toggle>
<label for=section-a2a499e8fa40193bb85003cabaff5d49 class="flex justify-between"><a href=/practice/hodl/>Хранение</a></label><ul><li><a href=/electrum/>Кошелек Электрум</a></li><li><a href=/blue/>Кошелек Blue</a></li><li><a href=/seedsigner/>SeedSigner: оффлайн-крепость для ваших биткоинов</a></li><li><a href=/coldcard/>Что такое Coldcard?</a></li></ul></li><li><input type=checkbox id=section-4e34fd6dae27eeab9274b5e370a300a7 class=toggle>
<label for=section-4e34fd6dae27eeab9274b5e370a300a7 class="flex justify-between"><a href=/practice/interact/>Взаимодействие</a></label><ul><li><a href=/practice/bitcoin-noda/>Каждому следует запустить собственную Биткоин-ноду!</a></li><li><a href=/oranzhpilling-za-5-minut/>Оранжпиллинг за 5 минут</a></li><li><a href=/5-sovetov-po-obucheniyu-bitcoin/>5 советов по обучению Биткоину</a></li></ul></li><li><input type=checkbox id=section-0af442a82e8087438ae3e5d932bfcd3c class=toggle>
<label for=section-0af442a82e8087438ae3e5d932bfcd3c class="flex justify-between"><a href=/practice/lightning/>Лайтнинг на практике</a></label><ul><li><a href=/phoenix/>Кошелек Phoenix</a></li><li><a href=/lnbits/>LNbits</a></li><li><a href=/alby-i-nostr/>Alby и Nostr</a></li><li><a href=/zapplanner/>Подписки с помощью Лайтнинг</a></li><li><a href=/lntips/>Телеграм-бот @LightningTipBot</a></li><li><a href=/ochishchaem-bitcoin-cherez-lajtning/>Очищаем биткоины через сеть Лайтнинг</a></li></ul></li></ul></li><li><input type=checkbox id=section-4f9efbc916a788429edff50248f79330 class=toggle>
<label for=section-4f9efbc916a788429edff50248f79330 class="flex justify-between"><a href=/rabbithole/>Кроличья нора</a></label><ul><li><input type=checkbox id=section-dd34bc6fc687d6e6fb62acabc34277a6 class=toggle>
<label for=section-dd34bc6fc687d6e6fb62acabc34277a6 class="flex justify-between"><a href=/books/>Книги</a></label><ul><li><input type=checkbox id=section-5055cff9cf4381c0971b08230d0253cf class=toggle>
<label for=section-5055cff9cf4381c0971b08230d0253cf class="flex justify-between"><a href=/whitepaper/>Белая книга</a></label><ul></ul></li><li><input type=checkbox id=section-e3198834b11fdb517332c04453209400 class=toggle>
<label for=section-e3198834b11fdb517332c04453209400 class="flex justify-between"><a href=/izobretaem-bitkoin/>Изобретаем Биткоин</a></label><ul><li><a href=/izobretaem-bitkoin/vstuplenie/>Вступление</a></li><li><a href=/izobretaem-bitkoin/glava-1/>Глава 1: Что такое Биткоин</a></li><li><a href=/izobretaem-bitkoin/glava-2/>Глава 2: Отказываемся от посредника</a></li><li><a href=/izobretaem-bitkoin/glava-3/>Глава 3: Proof of Work</a></li><li><a href=/izobretaem-bitkoin/glava-4/>Глава 4: Майнинг</a></li><li><a href=/izobretaem-bitkoin/glava-5/>Глава 5: Обеспечение безопасности реестра</a></li><li><a href=/izobretaem-bitkoin/glava-6/>Глава 6: Форки и атаки 51%</a></li><li><a href=/izobretaem-bitkoin/glava-7/>Глава 7: Учетные записи, не идентифицирующие личность</a></li><li><a href=/izobretaem-bitkoin/glava-8/>Глава 8: Кто устанавливает правила?</a></li><li><a href=/izobretaem-bitkoin/glava-9/>Глава 9: Что дальше?</a></li></ul></li><li><input type=checkbox id=section-f289993761aca4a4b180363fe368f984 class=toggle>
<label for=section-f289993761aca4a4b180363fe368f984 class="flex justify-between"><a href=/suverenitet-posredstvom-matematiki/>Суверенитет посредством математики</a></label><ul><li><a href=/suverenitet-posredstvom-matematiki/intro/>Предисловие</a></li><li><a href=/suverenitet-posredstvom-matematiki/glava-1/>Глава 1: Вся наша жизнь — торговля</a></li><li><a href=/suverenitet-posredstvom-matematiki/glava-2/>Глава 2: Финансовый атеизм</a></li><li><a href=/suverenitet-posredstvom-matematiki/glava-3/>Глава 3: Доверчивость</a></li><li><a href=/suverenitet-posredstvom-matematiki/glava-4/>Глава 4: Непорочное зачатие</a></li><li><a href=/suverenitet-posredstvom-matematiki/glava-5/>Глава 5: Proof of Work</a></li><li><a href=/suverenitet-posredstvom-matematiki/glava-6/>Глава 6: Редкость</a></li><li><a href=/suverenitet-posredstvom-matematiki/glava-7/>Глава 7: Ходл Он</a></li><li><a href=/suverenitet-posredstvom-matematiki/glava-8/>Глава 8: Изменение правил</a></li><li><a href=/suverenitet-posredstvom-matematiki/glava-9/>Глава 9: Деньги как акселератор</a></li><li><a href=/suverenitet-posredstvom-matematiki/glava-10/>Глава 10: Окружающая среда</a></li><li><a href=/suverenitet-posredstvom-matematiki/glava-11/>Глава 11: Новая форма жизни</a></li><li><a href=/suverenitet-posredstvom-matematiki/glava-12/>Глава 12: Будущее</a></li><li><a href=/suverenitet-posredstvom-matematiki/mysli/>Размышления</a></li></ul></li><li><input type=checkbox id=section-c0b499506f23962152d4aaeec11bead1 class=toggle>
<label for=section-c0b499506f23962152d4aaeec11bead1 class="flex justify-between"><a href=/vojna-za-razmer-bloka/>Война за размер блока</a></label><ul><li><a href=/vojna-za-razmer-bloka/glava-1/>Глава 1: Первый удар</a></li><li><a href=/vojna-za-razmer-bloka/glava-2/>Глава 2: Начало</a></li><li><a href=/vojna-za-razmer-bloka/glava-3/>Глава 3: Масштабирование I Монреаль</a></li><li><a href=/vojna-za-razmer-bloka/glava-4/>Глава 4: Масштабирование II Гонконг</a></li><li><a href=/vojna-za-razmer-bloka/glava-5/>Глава 5: SegWit</a></li><li><a href=/vojna-za-razmer-bloka/glava-6/>Глава 6: Сеть Lightning</a></li><li><a href=/vojna-za-razmer-bloka/glava-7/>Глава 7: Bitcoin Classic</a></li><li><a href=/vojna-za-razmer-bloka/glava-8/>Глава 8: Круглый стол в Гонконге</a></li><li><a href=/vojna-za-razmer-bloka/glava-9/>Глава 9: Фейковый Сатоши</a></li><li><a href=/vojna-za-razmer-bloka/glava-10/>Глава 10: DAO</a></li><li><a href=/vojna-za-razmer-bloka/glava-11/>Глава 11: Масштабирование III Милан</a></li><li><a href=/vojna-za-razmer-bloka/glava-12/>Глава 12: Bitcoin Unlimited</a></li><li><a href=/vojna-za-razmer-bloka/glava-13/>Глава 13: Биржи</a></li><li><a href=/vojna-za-razmer-bloka/glava-14/>Глава 14: ASICBoost</a></li><li><a href=/vojna-za-razmer-bloka/glava-15/>Глава 15: Логово драконов</a></li><li><a href=/vojna-za-razmer-bloka/glava-16/>Глава 16: Litecoin</a></li><li><a href=/vojna-za-razmer-bloka/glava-17/>Глава 17: UASF – Активируемый пользователями софтфорк</a></li><li><a href=/vojna-za-razmer-bloka/glava-18/>Глава 18: Нью-Йоркское соглашение</a></li><li><a href=/vojna-za-razmer-bloka/glava-19/>Глава 19: Bitcoin Cash</a></li><li><a href=/vojna-za-razmer-bloka/glava-20/>Глава 20: SegWit2x</a></li><li><a href=/vojna-za-razmer-bloka/glava-21/>Глава 21: Победа</a></li></ul></li><li><input type=checkbox id=section-e5860353bd62663c37a33bec590802ab class=toggle>
<label for=section-e5860353bd62663c37a33bec590802ab class="flex justify-between"><a href=/bychij-kejs-dlya-bitcoin/>Бычий кейс для Биткоина</a></label><ul><li><a href=/bychij-kejs-dlya-bitcoin/predislovie/>Предисловие от Майкла Сэйлора</a></li><li><a href=/bychij-kejs-dlya-bitcoin/prolog/>Пролог</a></li><li><a href=/bychij-kejs-dlya-bitcoin/glava-1/>Глава 1: Генезис и происхождение денег</a></li><li><a href=/bychij-kejs-dlya-bitcoin/glava-2/>Глава 2: Атрибуты хорошего средства сбережения</a></li><li><a href=/bychij-kejs-dlya-bitcoin/glava-3/>Глава 3: Эволюция денег</a></li><li><a href=/bychij-kejs-dlya-bitcoin/glava-4/>Глава 4: Форма монетизации</a></li><li><a href=/bychij-kejs-dlya-bitcoin/glava-5/>Глава 5: Новая денежная база</a></li><li><a href=/bychij-kejs-dlya-bitcoin/epilog/>Эпилог</a></li></ul></li><li><input type=checkbox id=section-4b442928210bf7bb8d82eb48c684874d class=toggle>
<label for=section-4b442928210bf7bb8d82eb48c684874d class="flex justify-between"><a href=/21-sposob/>21 способ</a></label><ul><li><a href=/21-sposob/vvedenie/>Введение</a></li><li><a href=/21-sposob/glava-0/>Глава 0</a></li><li><a href=/21-sposob/glava-01/>Глава 0.1</a></li><li><a href=/21-sposob/glava-1-bitcoin-eto-ideya/>Глава 1. Биткоин — это идея</a></li><li><a href=/21-sposob/glava-2-bitcoin-eto-vremya/>Глава 2. Биткоин — это время</a></li><li><a href=/21-sposob/glava-3-bitcoin-volshebnye-internet-dengi/>Глава 3. Биткоин — волшебные интернет-деньги</a></li><li><a href=/21-sposob/glava-6-bitcoin-eto-cifrovaya-redkost/>Глава 6. Биткоин – это цифровая редкость</a></li></ul></li><li><input type=checkbox id=section-4821edbebdbff526db8aaad627df8c2e class=toggle>
<label for=section-4821edbebdbff526db8aaad627df8c2e class="flex justify-between"><a href=/suverennaya-lichnost/>Суверенная личность</a></label><ul><li><a href=/suverennaya-lichnost/glava-1/>Глава 1: Переходный период 2000 года</a></li><li><a href=/suverennaya-lichnost/rezyume/>Резюме</a></li><li><a href=/suverennaya-lichnost/glava-2/>Глава 2: Метаполитические трансформации в исторической перспективе</a></li><li><a href=/suverennaya-lichnost/glava-3/>Глава 3: К востоку от Эдема</a></li><li><a href=/suverennaya-lichnost/glava-4/>Глава 4: Последние дни политики</a></li><li><a href=/suverennaya-lichnost/glava-5/>Глава 5: Самочувствие национального государства</a></li><li><a href=/suverennaya-lichnost/glava-6/>Глава 6: Мегаполитика информационной эпохи</a></li><li><a href=/suverennaya-lichnost/glava-7/>Глава 7: Выход за рамки локальности</a></li><li><a href=/suverennaya-lichnost/glava-8/>Глава 8: Конец уравнительной экономики</a></li><li><a href=/suverennaya-lichnost/glava-9/>Глава 9: Национализм, реакция и новые луддиты</a></li><li><a href=/suverennaya-lichnost/glava-10/>Глава 10: Сумерки демократии</a></li><li><a href=/suverennaya-lichnost/glava-11/>Мораль и преступность в “естественной экономике” информационного века</a></li></ul></li><li><a href=/doroga-k-rabstvu/>Дорога к рабству</a></li><li><a href=/bitcoin-money/>Биткоин-деньги</a></li></ul></li><li><a href=/videos/>Видео</a><ul></ul></li></ul></li></ul><div class=menuSep></div><ul><li><a href=/posts/>Блог</a></li><li><input type=checkbox id=section-d90442343f58c582906ebc7e255e7116 class=toggle>
<label for=section-d90442343f58c582906ebc7e255e7116 class="flex justify-between"><a href=/contribute/>Принять участие</a></label><ul><li><a href=/syntax/>Оформление статей</a></li><li><a href=/github/>Как добавить статью?</a></li><li><a href=/obsidian/>Публикация статей через Obsidian</a></li></ul></li><li><a href=/feedback/>Обратная связь</a></li><li><a href=https://github.com/21ideas-org/21ideas.org target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Механизм работы Lightning Network</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#0-зачем>0. Зачем?</a></li><li><a href=#1-идея>1. Идея</a><ul><li><a href=#11-платежный-канал>1.1. Платежный канал</a></li><li><a href=#12-сеть-платежных-каналов>1.2. Сеть платежных каналов</a></li><li><a href=#13-проблема-доверия>1.3. Проблема доверия</a></li></ul></li><li><a href=#2-смарт-контракты>2. Смарт-контракты</a><ul><li><a href=#21-авторизация>2.1. Авторизация</a></li><li><a href=#22-кооперация>2.2. Кооперация</a></li><li><a href=#23-сроки>2.3. Сроки</a></li></ul></li><li><a href=#3-реализация-канала>3. Реализация канала</a><ul><li><a href=#31-открытие-канала>3.1. Открытие канала</a></li><li><a href=#32-использование-канала>3.2. Использование канала</a></li></ul></li><li><a href=#4-lightning-network>4. Lightning Network</a><ul><li><a href=#41-платежный-канал-через-посредника>4.1. Платежный канал через посредника</a></li><li><a href=#42-маршрутизация>4.2. Маршрутизация</a></li><li><a href=#43-экономика-комиссий>4.3. Экономика комиссий</a></li><li><a href=#44-критика>4.4. Критика</a></li></ul></li><li><a href=#5-ln-сегодня>5. LN сегодня</a></li></ul></nav></aside></header><div class=pageCover><img src=/img/mln-850.jpeg></div><h1>Lightning Network</h1><div class=pageDate>30 января 2018 г.</div><article class=markdown><blockquote class="book-hint btc"><p><em>Пояснение механизма работы Lightning Network подготовлено</em> <a href=https://medium.com/@x0100><em>Дмитрием Лаптевым</em></a><em>.</em>  Данная статья также доступна на <a href=https://medium.com/@x0100/lightning-network-45b4b2119d97>английском</a>.</p><p><a href=/contribute>Поддержать проект</a>.</p></blockquote><p>В части 0 посмотрим, зачем это надо. В части 1 обсудим поверхностно общую идею платежных каналов, Lightning Network и проблемы. В части 2 введем необходимые строительные блоки. В части 3 наконец-то опишем более строго детали работы платежного канала. В части 4 по-быстрому построим Lightning из платежных каналов, расскажем про критику и комиссии. В части 5 немного подытожим.</p><h1 id=0-зачем>0. Зачем?
<a class=anchor href=#0-%d0%b7%d0%b0%d1%87%d0%b5%d0%bc>#</a></h1><p>Блокчейн биткоина — это своего рода децентрализованная база данных, в которой сохраняются все транзакции сети. При этом “все транзакции” — это довольно фундаментальная часть определения протокола. Чтобы система была по-настоящему децентрализованной и чтобы при этом не допустить ни одной ошибки, нужно, чтобы тысячи узлов сети перепроверяли и сохраняли все транзакции.</p><p>Это, разумеется, совсем не способствует масштабируемости: блокчейн занимает десятки гигабайт на диске, блоки переполнены, комиссии растут, люди ругаются и форкают биткоин. Поэтому в данный момент активно разрабатываются альтернативные решения. Одним из таких решений являются <em>Lightning Network (далее LN)</em>.</p><h1 id=1-идея>1. Идея
<a class=anchor href=#1-%d0%b8%d0%b4%d0%b5%d1%8f>#</a></h1><p>Идея решений второго уровня <em>(second layer solutions)</em>, к которым и относится LN, звучит довольно просто.</p><blockquote class="book-hint btc"><em>Вместо того, чтобы записывать и верифицировать все транзакции на блокчейне, давайте будем проводить большую часть платежей вне сети (off-chain), а на главный блокчейн будем время от времени по желанию синхронизировать балансы и разрешать на нем конфликты. А работать это будет как всегда с помощью криптомагии.</em></blockquote><p>Звучит интригующе, но совсем непонятно как…</p><h2 id=11-платежный-канал>1.1. Платежный канал
<a class=anchor href=#11-%d0%bf%d0%bb%d0%b0%d1%82%d0%b5%d0%b6%d0%bd%d1%8b%d0%b9-%d0%ba%d0%b0%d0%bd%d0%b0%d0%bb>#</a></h2><p>Начнем с того, как можно упростить жизнь двум людям, Алисе и Бобу, которые часто расплачиваются между собой. Предлагается следующая схема.</p><ol><li>Алиса и Боб отправляют депозиты на адрес, который управляется ими совместно с помощью двух приватных ключей.</li><li>Каждый из них создает специальную транзакцию — смарт-контракт (да, в биткоине есть смарт-контракты, об этом в следующей части). Эта транзакция корректна, но пока не записывается в блокчейн.</li><li>Изначально транзакции содержат информацию о том, что Алиса и Боб могут забрать свои депозиты обратно.</li><li>Когда Алиса расплачивается с Бобом, они по обоюдному согласию обновляют информацию в этих транзакциях. Алиса соглашается получить меньше изначального депозита, Боб — больше. По сути эти транзакции представляют собой долговые обязательства (IOU, I owe you). Но в отличии от большинства банковских долговых обязательств, LN платежи 100% обеспечены и могут быть реализованы в любой момент.</li><li>Так они могут обмениваться небольшими суммами (в пределах их депозитов) друг с другом, хоть до бесконечности.</li><li>В какой-то момент любая сторона может решить рассчитаться окончательно. Тогда Алиса (или Боб) просто записывают одну финальную транзакцию в главный блокчейн и получают суммы депозитов с учетом всех промежуточных платежей.</li></ol><p>Пункты 1–3 в этой схеме называются открытием платежного канала <em>(payment channel, канал микроплатежей)</em>. Пункты 4 и 5 — использованием канала. Пункт 6—закрытием платежного канала.</p><blockquote class="book-hint btc"><em>В блокчейн записывается всего две транзакции: перечисление депозитов для открытия канала и финальная транзакция (закрытие канала). Все промежуточные платежи осуществляются без синхронизации с блокчейном, поэтому проходят они бесплатно и мгновенно.</em></blockquote><h2 id=12-сеть-платежных-каналов>1.2. Сеть платежных каналов
<a class=anchor href=#12-%d1%81%d0%b5%d1%82%d1%8c-%d0%bf%d0%bb%d0%b0%d1%82%d0%b5%d0%b6%d0%bd%d1%8b%d1%85-%d0%ba%d0%b0%d0%bd%d0%b0%d0%bb%d0%be%d0%b2>#</a></h2><p>Сами по себе платежные каналы между двумя людьми — вещь не особо полезная. В конце концов, с большинством людей мы не проводим частых регулярных транзакций. Но…</p><blockquote class="book-hint btc"><em>Когда платежные каналы выстраиваются в сеть, появляется возможность проводить платежи между любыми участниками, между которыми есть путь в графе этой сети (даже если они не связаны напрямую). Это и есть основная идея Lightning Network.</em></blockquote><div class=imageWrapper><img src=/img/mln-851.png><p><em>Так выглядел граф платежных каналов на момент 22.01.2018 (<a href=https://lnmainnet.gaben.win/>https://lnmainnet.gaben.win</a>).</em></p></div><p>В принципе, аналогично протоколу TCP, простому человеку достаточно иметь всего один открытый канал, чтобы проводить транзакции с кем угодно.</p><p>Конечно, нужно еще искать оптимальные пути между двумя людьми, и еще нужно как-то мотивировать участников обрабатывать чужие платежи. Но начнем с основной проблемы: с проблемы доверия.</p><h2 id=13-проблема-доверия>1.3. Проблема доверия
<a class=anchor href=#13-%d0%bf%d1%80%d0%be%d0%b1%d0%bb%d0%b5%d0%bc%d0%b0-%d0%b4%d0%be%d0%b2%d0%b5%d1%80%d0%b8%d1%8f>#</a></h2><p>Как часто бывает в криптографии, систему платежных каналов легко себе представить, если все стороны доверяют друг другу. Нет необходимости городить огород с депозитами, ключами, специальными транзакциями. Можно просто записывать, кто кому сколько должен.</p><p>Дело за малым: понять, как можно реализовать канал платежей и сеть этих каналов <em>без доверия</em>. Основных проблем будет три.</p><ol><li>Оба депозита от Алисы и Боба хранятся на общем кошельке. Если Боб откажется подписывать транзакции, то как Алисе вернуть свой депозит?</li><li>В процессе расчетов создается много версий долговых обязательств. Предположим, что в основном Алиса платит Бобу. Тогда в финальной версии транзакции Боб получает больше своего депозита, а Алиса — меньше. Но Алиса может схитрить и самовольно записать в блокчейн самую первую валидную версию транзакции, как будто Боб никогда и не получал денег. Что тогда делать Бобу?</li><li>Если Алиса и Боб передают деньги по сети каналов через Витю, то как они могут убедиться, что Витя действительное передаст деньги, а не заберет их себе?</li></ol><p>Назовем эти проблемы соответственно: <em>“проблема общего депозита”</em>, <em>“проблема последней транзакции”</em> и <em>“проблема посредника”</em>.</p><p>Все перечисленные выше проблемы решаются с помощью буквально парочки трюков. Но обо всем по порядку: для начала введем несколько необходимых строительных блоков…</p><h1 id=2-смарт-контракты>2. Смарт-контракты
<a class=anchor href=#2-%d1%81%d0%bc%d0%b0%d1%80%d1%82-%d0%ba%d0%be%d0%bd%d1%82%d1%80%d0%b0%d0%ba%d1%82%d1%8b>#</a></h1><p>Биткоин поддерживает простейший <a href=https://en.bitcoin.it/wiki/Script>язык смарт-контрактов <em>Script</em></a>. В каждой биткоин-транзакции есть специальное поле, которое содержит скрипт на этом языке. Этот скрипт проверяет, при выполнении каких условий выход транзакции может быть потрачен.</p><p><em>“Потратить выход транзакции A”</em> — это на самом деле более технически корректный способ сказать “потратить деньги с адреса/кошелька K, на который они были зачислены с помощью транзакции A”.</p><blockquote class="book-hint btc"><em>В отличии, например, от эфириума, возможности смарт-контрактов биткоина намного более ограничены. Связано это с тем, что Script не является полным по Тьюрингу. Например, в нем нельзя использовать циклы/рекурсию и нельзя создавать переменные (отсутствует память).</em></blockquote><p>Про устройство транзакций и использование скриптов можно почитать в следующей статье:</p><div class=imageWrapper><img src=/img/mln-855.png><p><em><a href=https://medium.com/lightningto-me/bitcoin-transactions-malleability-segwit-and-scaling-258af8ed9cbf>Bitcoin: transactions, malleability, SegWit and scaling</a></em></p></div><p>Рассмотрим несколько важных операций этого языка.</p><h2 id=21-авторизация>2.1. Авторизация
<a class=anchor href=#21-%d0%b0%d0%b2%d1%82%d0%be%d1%80%d0%b8%d0%b7%d0%b0%d1%86%d0%b8%d1%8f>#</a></h2><p>Пожалуй, самая стандартная часть любой транзакции — это проверка подписи. Пусть транзакция A зачисляет средства на некий адрес K. Чтобы дальше потратить деньги с K, нужно доказать наличие ключа. За это отвечает операция OP_CheckSig.</p><p>Но при желании, можно также проверить что-нибудь дополнительное. Например, можно проверить, что у человека есть секретное число, хеш от которого равен заданному значению. Для этого нужно две операции: OP_SHA256 (считает хэш) и OP_EqualVerify (проверяет равенство). Зачем это нужно станет понятно в части 4.</p><h2 id=22-кооперация>2.2. Кооперация
<a class=anchor href=#22-%d0%ba%d0%be%d0%be%d0%bf%d0%b5%d1%80%d0%b0%d1%86%d0%b8%d1%8f>#</a></h2><p>Другой пример простейших смарт-контрактов на биткоине основан на операции OP_CheckMultiSig. Она позволяет тратить средства только при подписании несколькими определенными ключами.</p><p>На этом принципе построены так называемые multiple signature кошельки. Примерно как ячейка в банке, которая закрывается на два замка (один ключ у работника банка, второй — у клиента).</p><h2 id=23-сроки>2.3. Сроки
<a class=anchor href=#23-%d1%81%d1%80%d0%be%d0%ba%d0%b8>#</a></h2><p>С относительно недавних пор биткоин также поддерживает операцию OP_CheckSequenceVerify, которая позволяет тратить средства только через какое-то фиксированное количество блоков.</p><p>Например, это позволяет дисциплинировать людей, которые не умеют откладывать деньги. Блокчейн работает лучше любой копилки: если пользователь решил заморозить сбережения на какой-то срок, то они будут гарантировано заморожены.</p><p>Но помимо этого сценария, OP_CheckSequenceVerify и другие компоненты активно используются в реализации платежного канала.</p><h1 id=3-реализация-канала>3. Реализация канала
<a class=anchor href=#3-%d1%80%d0%b5%d0%b0%d0%bb%d0%b8%d0%b7%d0%b0%d1%86%d0%b8%d1%8f-%d0%ba%d0%b0%d0%bd%d0%b0%d0%bb%d0%b0>#</a></h1><p>Теперь, когда все строительные блоки на месте, можно описать некоторые детали работы платежного канала.</p><p>На самом деле разновидностей платежных каналов <a href=https://en.bitcoin.it/wiki/Payment_channels>довольно много</a>, и первую из них предложил еще Сатоши. Я буду примерно ориентироваться на спецификацию, которая называется <em>Poon-Dryja payment channels</em> (по имени главных авторов <a href=https://lightning.network/lightning-network-paper.pdf>статьи про Lightning Network</a>).</p><h2 id=31-открытие-канала>3.1. Открытие канала
<a class=anchor href=#31-%d0%be%d1%82%d0%ba%d1%80%d1%8b%d1%82%d0%b8%d0%b5-%d0%ba%d0%b0%d0%bd%d0%b0%d0%bb%d0%b0>#</a></h2><ol><li>Алиса и Боб создают транзакцию/транзакции, которые зачисляют средства на общий адрес-депозит <em>O</em>. Предположим, что <em>X</em> биткоинов зачисляется с кошелька Алисы и <em>Y</em> — с кошелька Боба. Средства с общего депозита можно потратить только при подписании одновременно ключами Алисы и Боба (OP_CheckMultiSig).</li><li>Первый трюк заключается в том, что они пока НЕ подписывают и НЕ транслируют созданную транзакцию в блокчейн (иначе Боб может обмануть Алису и заморозить её средства навечно).</li><li>Вместо этого Алиса и Боб создают две новые транзакции возвращения депозитов (соответственно <em>A1</em> и <em>B1</em>). Входом этих транзакций являются средства с общего депозита (выход транзакции <em>O</em>). Выходов у транзакций два: X уйдет обратно на адрес Алисе, <em>Y</em> — Бобу. На самом деле все немного сложнее, но об это чуть позже.</li><li>Дальше Боб подписывает транзакцию <em>A1</em> и передает её Алисе. Алиса подписывает транзакцию <em>B1</em> и передает её Бобу.</li><li>Теперь транзакцию зачисления депозитов можно смело транслировать в блокчейн, никто никого не обманет. Если Боб откажется кооперировать, Алиса всегда сможет подписать транзакцию <em>A1</em>, записать её в блокчейн и вернуть свой депозит.</li></ol><div class=imageWrapper><img src=/img/mln-852.png><p><em>Транзакции возврата депозитов.</em></p></div><p>Теперь “проблема общего депозита” решена. Открытие канала можно провести без доверия второй стороне.</p><blockquote class="book-hint btc"><em>Интересный факт. Еще полгода назад (до внедрения SegWit) подписание выхода неподтвержденной транзакции (пункт 4) провернуть было намного сложнее из-за проблемы пластичности транзакций (transaction malleability).</em></blockquote><h2 id=32-использование-канала>3.2. Использование канала
<a class=anchor href=#32-%d0%b8%d1%81%d0%bf%d0%be%d0%bb%d1%8c%d0%b7%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5-%d0%ba%d0%b0%d0%bd%d0%b0%d0%bb%d0%b0>#</a></h2><p>Платежи внутри канала на самом деле осуществляются переписыванием транзакций <em>A1</em> и <em>B1</em> на новые транзакции.</p><ol><li>Алиса платит Бобу за кружку кофе, которая стоит <em>C</em>.</li><li>При этом Алиса соглашается, что при закрытии канала она заберет не изначальную сумму <em>X</em>, а <em>X’=(X-C)</em>.</li><li>Боб при этом получит <em>Y’=(Y+C)</em>.</li></ol><p>Соответственно, новые транзакции A2 и B2 будут выглядеть точно также, как <em>A1</em> и <em>B1</em>, но с новыми суммами. Любая из сторон может в любой момент закрыть канал, записав последнюю версию транзакции в блокчейн.</p><p>Как убедиться, что Алиса не запишет в блокчейн транзакцию A1 вместо транзакции A2? Для этого есть еще один трюк.</p><ol><li>Каждый раз, когда Алиса и Боб создают новые транзакции, они выбирают <em>одноразовый приватный ключ</em>, который нужен, чтобы забрать депозит (OP_CheckSig).</li><li>При каждом очередном платеже <em>i</em>, Алиса показывает Бобу предыдущий приватный ключ <em>AK(i-1)</em>, и создает новый ключ AKi для новой транзакции. Боб не принимает оплату без предыдущего ключа.</li><li>Если Боб знает ключ, то он может потратить все деньги Алисы. Но только в случае, если Алиса решит записать неправильную транзакцию в блокчейн.</li><li>Таким образом, Алиса всегда заинтересована в том, чтобы записывать в блокчейн только самую последнюю транзакцию.</li></ol><p><em>Последняя маленькая модификация</em>. Для того, чтобы у Боба была возможность оспорить транзакцию Алисы и предоставить её ключ, Бобу нужно время. Поэтому Алиса будет получать свой депозит не сразу, а через какое-то количество блоков T (OP_CheckSequenceVerify). Например, через 48 блоков, то есть примерно 8 часов.</p><div class=imageWrapper><img src=/img/mln-853.png><p><em>Финальный вид транзакций, используемых для платежного канала.</em></p></div><p>Если Алиса подписывает одну из своих транзакций (они уже подписаны Бобом), и транслирует эту транзакцию в блокчейн, то возможны два сценария.</p><ol><li>Алиса транслирует финальную транзакцию => Боб не знает последнего ключа Алисы <em>AKi</em>. Это корректное закрытие канала, все должны получить свои деньги. Алиса получит их через какое-то время.</li><li>Алиса пытается записать старую транзакцию вместо финальной => Алиса пытается обмануть Боба. В этом случае Боб знает ключ Алисы и он может воспользоваться им, чтобы получить все средства Алисы. Разумеется, Алиса не заинтересована в этом сценарии.</li></ol><p>Итак, <em>“проблема последней транзакции”</em> тоже решена и платежный канал между двумя людьми готов. Теперь также становятся очевидны некоторые плюсы и минусы.</p><blockquote class="book-hint btc"><em>Преимущества: 1. платежи внутри канала мгновенны и бесплатны, они не создают нагрузки на главный блокчейн. 2. стороны не обязаны доверять друг другу.</em></blockquote><blockquote class="book-hint btc"><em>Недостатки: 1. депозиты заблокированы на все время существования канала. 2. обе стороны должны периодически появляться онлайн (как минимум раз в T).</em></blockquote><p>👌 На самом деле оба недостатка важны для платежных каналов между двумя людьми, но не очень важны в контексте Lightning Network. Первый недостаток перестает быть недостатком, если один платежный канал может быть использован для транзакций с разными людьми.</p><p>Второй недостаток отсутствует в LN, так как проверку корректности может совершать любой участник сети (если Вася вскроет мошенничество Алисы, то он разделит с Бобом конфискованные средства Алисы).</p><h1 id=4-lightning-network>4. Lightning Network
<a class=anchor href=#4-lightning-network>#</a></h1><h2 id=41-платежный-канал-через-посредника>4.1. Платежный канал через посредника
<a class=anchor href=#41-%d0%bf%d0%bb%d0%b0%d1%82%d0%b5%d0%b6%d0%bd%d1%8b%d0%b9-%d0%ba%d0%b0%d0%bd%d0%b0%d0%bb-%d1%87%d0%b5%d1%80%d0%b5%d0%b7-%d0%bf%d0%be%d1%81%d1%80%d0%b5%d0%b4%d0%bd%d0%b8%d0%ba%d0%b0>#</a></h2><p>Предположим теперь, что Алиса и Боб не имеют открытого канала между собой, но они оба поддерживают открытый канал с Витей. Алиса может безопасно передать деньги Вите, Витя может безопасно передать деньги Бобу.</p><p>Но как убедиться, что Витя, получив деньги, действительно передаст их дальше Бобу?</p><p>На самом деле идея немного похожа на предыдущий трюк, только вместо одноразовых ключей используется некоторое секретное число.</p><ol><li>Боб генерирует секретное число <em>S</em>, хэш от этого секретного ключа <em>HS</em> и передает эту информацию Алисе. <em>HS</em> при этом может использоваться как виртуальный чек.</li><li>Алиса создает транзакцию <em>AV</em>, которая передает деньги Вите, но только в случае, если Витя предоставит секретное число <em>S</em>. Для этого она использует скрипт, который проверяет равенство хэша предоставленного числа и значения <em>HS</em> (тут как раз и используются операции OP_SHA256 и OP_EqualVerify).</li><li>Витя создает аналогичную транзакцию VB, которая передает деньги Бобу, но только в случае, если Боб предоставит секретное число.</li><li>Боб видит, что он может получить деньги от Вити, и показывает ему секретное число <em>S</em>.</li><li>Витя теперь может доказать, что он передал деньги Бобу, и соответственно он может обналичить транзакцию <em>AV</em>.</li></ol><p>Тут есть несколько вариантов развития событий.</p><ol><li>Во-первых, Вите не имеет смысла обманывать Алису. Он не может не передать деньги Бобу, потому что иначе Витя все равно не получит деньги от Алисы.</li><li>Но Боб может решит обмануть Витю и не передать ему секретное число. При этом он может закрыть канал с Витей и записать транзакцию VB в блокчейн. Но для вывода денег ему все равно придется показать свое секретное число, и тут-то Витя его и узнает.</li></ol><p>Тут есть пара нетривиальных нюансов с тем, как выбрать время, в течении которого Алиса, Боб и Витя могут разрешить конфликты. Но эти более технические подробности выходят за рамки этой вводной статьи. Если интересно — гуглите <em>Hash Time-Locked Contracts (HTLCs)</em>.</p><h2 id=42-маршрутизация>4.2. Маршрутизация
<a class=anchor href=#42-%d0%bc%d0%b0%d1%80%d1%88%d1%80%d1%83%d1%82%d0%b8%d0%b7%d0%b0%d1%86%d0%b8%d1%8f>#</a></h2><p>На практике Алиса и Боб могут быть связаны между собой не через одного общего знакомого Витю, а через несколько неизвестных/анонимных посредников по всему миру. Проблема поиска пути в графе узлов сети называется <em>проблемой маршрутизации</em>.</p><div class=imageWrapper><img src=/img/mln-854.png><p><em>Географическое распределение узлов тестовой сети (</em><a href=https://explorer.acinq.co/#/><em>https://explorer.acinq.co/#/</em></a><em>).</em></p></div><p>Вопрос маршрутизации на самом деле является областью активных исследований на данный момент. Оптимальный путь в графе зависит от многих динамических факторов: наличия узлов, топологии сети, пропускной способности каналов, комиссии промежуточных узлов.</p><p>Не вдаваясь в подробности, поиск пути и передача платежей в LN реализуется на основе <a href=https://ru.wikipedia.org/wiki/%D0%9B%D1%83%D0%BA%D0%BE%D0%B2%D0%B0%D1%8F_%D0%BC%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F><em>Onion routing</em></a> — технологии анонимного распространения информации по peer-to-peer сетям. Именно так, например, работает <a href=https://www.torproject.org/>Tor</a>.</p><p>Все децентрализовано, весь трафик зашифрован. Никто не знает, от кого пришли деньги и кому они пойдут дальше. Отсюда еще одно преимущество.</p><blockquote class="book-hint btc"><em>Преимущества: Lightning Network намного более анонимна, чем сам биткоин. Во-первых, промежуточные транзакции не записываются в публичный блокчейн, их видит всего несколько участников. Во-вторых, даже среди этих участников, только первый и последний человек точно знают, от кого и кому переводятся средства.</em></blockquote><h2 id=43-экономика-комиссий>4.3. Экономика комиссий
<a class=anchor href=#43-%d1%8d%d0%ba%d0%be%d0%bd%d0%be%d0%bc%d0%b8%d0%ba%d0%b0-%d0%ba%d0%be%d0%bc%d0%b8%d1%81%d1%81%d0%b8%d0%b9>#</a></h2><p>Остается два очевидных вопроса.</p><p><strong>Вопрос номер 1:</strong> зачем посредникам обрабатывать чужие платежи?</p><p>Во-первых, потому что им самим так проще пользоваться LN. Во-вторых, потому что они получают с этого очень маленькую, но все-таки комиссию.</p><p>На данный момент сеть поддерживают в основном энтузиасты и комиссия практически нулевая: 1 сатоши, или ~0.01 <em>цента</em> за каждого посредника.</p><blockquote class="book-hint btc"><em>Пропускная способность каналов — намного менее ценный ресурс, чем размер блока. Каналы открывать просто и недорого. Поэтому комиссии в LN на порядки ниже комиссий в основном блокчейне.</em></blockquote><p><strong>Вопрос номер 2:</strong> а как же комиссия за открытие/закрытие канала?</p><p>Действительно, эта комиссия может иногда составлять десятки долларов. Таким образом, платежи будут тем выгоднее, чем реже придется открывать/закрывать каналы.</p><p>Это мотивирует людей открывать каналы с бóльшими депозитами, и использовать каналы в двух направлениях: не только для исходящих платежей, но и для получения средств.</p><p><em>Пример:</em> я открываю канал, зачисляю туда 1000 долларов, и использую канал только для исходящих платежей. Оборот в канале составит 1000 долларов, примерно 20 долларов уйдет на открытие и закрытие канала. То есть суммарно комиссии составят 2%. Немного лучше, чем виза и мастеркард, но явно больше, чем хотелось бы.</p><p>Ситуация кардинально меняется, когда я начинаю использовать Lightning на всю катушку: вкладывать большие суммы и получать деньги через каналы, а не только тратить их. Тогда, в зависимости от пропорции полученных/потраченных денег, <em>канал может быть открыт вечно и комиссии в пределе будут стремиться к нулю.</em></p><h2 id=44-критика>4.4. Критика
<a class=anchor href=#44-%d0%ba%d1%80%d0%b8%d1%82%d0%b8%d0%ba%d0%b0>#</a></h2><p>В интернете можно найти большое количество критики решений второго уровня в целом и Lightning Network в частности. Какие-то пункты действительно заслуживают внимания, многие оказываются устаревшими. Приведем несколько примеров.</p><blockquote><p><em>1. Использование LN приведет к централизации: пользователям будет выгодно подключаться к крупным хабам и эти хабы будут контролировать весь трафик.</em></p></blockquote><p>Такой риск есть и стоит уделять этому внимание, но риск не очень велик. Во-первых, экономически выгодно и очень просто будет создать новый узел в обход больших хабов. Во-вторых, алгоритмы маршрутизации предусматривают балансировку трафика. В-третьих, пока что такой картины <a href=https://lnmainnet.gaben.win/>не наблюдается</a>. В будущем, я надеюсь, топология сети будет оптимально выстраиваться алгоритмически.</p><blockquote><p><em>2. Недостаточная пропускная способность каналов приведет к тому, что LN будет забита, комиссии будут расти, и вскоре ситуация будет такой же, как и в основном блокчейне.</em></p></blockquote><p>Опять же, как только такое начнет происходить, у людей появится большая экономическая мотивация запускать свои узлы. В отличии от размера блока, количество узлов практически неограниченно.]</p><blockquote><p><em>3. Эффективная маршрутизация на большом количестве peer-to-peer узлов невозможна. Особенно с учетом сложности открытия новых каналов.</em></p></blockquote><p>До этих проблем еще очень и очень и очень далеко, а исследования в этом направлении активно ведутся уже сейчас. Что-нибудь придумают.</p><blockquote><p><em>4. Каналы нужно постоянно открывать и закрывать, комиссии, потраченные на это, будут огромны и LN окажется невыгодной.</em></p></blockquote><p>На самом деле это проблема из прошлого, про которую почему-то до сих пор говорят. Ранние версии платежных каналов действительно были однонаправленными, а сам канал мог существовать только ограниченное время. Сейчас эти проблемы решены.</p><blockquote><p><em>5. Для использования LN необходимо быть онлайн.</em></p></blockquote><p>Опять же, в отличии от ранних реализаций LN, пользователю нет необходимости все время быть онлайн: другие узлы сети проверяют, что два владельца канала не пытаются обмануть друг друга. Действительно необходимо быть онлайн только для отправки и получения платежей, что безусловно является ограничением, но уже намного менее важным.</p><blockquote><p><em>6. LN не совместимо с холодными хранилищами (cold storage).</em></p></blockquote><p>Очень правильно замечание. Депозиты платежных каналов храняться в кошельке подключенном к интернету <em>(hot wallet)</em>. Для защиты от хакеров необходимо будет очень серьезно подходить к безопасности.</p><blockquote><p><em>7. LN платежи — это не безопасно.</em></p></blockquote><p>LN платежи действительно чуть более опасны, чем платежи на основном блокчейне. Но только в одном случае: <a href=https://blog.bitmex.com/the-lightning-network/>при успешной 51% атаке на блокчейн биткоина</a>. Риск этого ничтожно мал.</p><h1 id=5-ln-сегодня>5. LN сегодня
<a class=anchor href=#5-ln-%d1%81%d0%b5%d0%b3%d0%be%d0%b4%d0%bd%d1%8f>#</a></h1><p>Самое важное, что вам нужно знать: Lightning уже реально работает.</p><p><a href=https://explorer.acinq.co/#/>Более тысячи узлов</a> в тестовой сети биткоина и <a href=https://lnmainnet.gaben.win/>более двухсот узлов</a> (число растет каждый день) в основной сети (mainnet) уже обрабатывают платежи и тестируют различный софт.</p><blockquote class=twitter-tweet><p lang=en dir=ltr>Bug testing should be on testnet, not mainnet. Especially when the devs are still losing money. 🙃 <a href=https://t.co/QYx94V0vpR>https://t.co/QYx94V0vpR</a></p>&mdash; elizabeth stark 🍠 (@starkness) <a href="https://twitter.com/starkness/status/953434418948927488?ref_src=twsrc%5Etfw">January 17, 2018</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p><em>Соонователь Lightning Labs пока не рекомендует поднимать узлы на мейннете.</em></p><p>Что касается софта, то есть три основных реализации: <a href=https://github.com/lightningnetwork/lnd>lnd</a> от Lightning Labs, <a href=https://github.com/ElementsProject/lightning>c-lightning</a> от Blockstream, <a href=https://github.com/ACINQ/eclair>eclair</a> от ACINQ. Эти команды уже не один год работали совместно, чтобы разработать общий стандарт взаимодействия узлов: <a href=https://github.com/lightningnetwork/lightning-rfc><em>Lightning Network Specifications (BOLTs)</em></a>. И вот буквально в конце 2017-ого года они провели полномасштабное успешное тестирование протокола платежей, все три реализации оказались совместимы.</p><p>Расплатиться реальными биткоинами используя LN можно пока буквально в трех-четырех онлайн-магазинах. Но это на целых три-четыре магазина больше, чем всего месяц назад, так что это уже большой успех 😊</p><p>Конечно, момент повсеместного перехода с on-chain биткоин платежей на off-chain платежи еще далеко. Огромную работу еще должны провести разработчики кошельков, платежных шлюзов, бирж, онлайн-магазинов. И, конечно, сами пользователи.</p><p>Самое интересное в этой истории, что более быстрые, анонимные и дешевые платежи — это только начало! На подходе еще больше анонимности, атомарные свопы, распределенные биржи и многое-многое другое. Будущее выглядит захватывающе! ⚡</p><p>Больше подробностей про LN по ссылкам: <a href=https://lightning.network/lightning-network-paper.pdf>1</a>, <a href=https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki>2</a>, <a href=https://github.com/lightningnetwork/lightning-rfc>3</a>, <a href=https://github.com/ElementsProject/lightning/blob/master/doc/deployable-lightning.pdf>4</a>, <a href=https://blog.bitmex.com/the-lightning-network/>5</a>.</p><hr><p>Комментируйте, критикуйте, задавайте вопросы, подписывайтесь! Авторский мини-канал про крипту в телеграме: <a href=https://t.me/cryptohodl>https://t.me/cryptohodl</a>. Больше об авторе: <a href=http://laptev.ch/>http://laptev.ch</a>. По вопросам использования материала пишите на <a href=mailto:d@laptev.ch>d@laptev.ch</a></p></article><zap-threads anchor=https://21ideas.org/mekhanizm-raboty-lightning/ relays=wss://21ideas.nostr1.com disable=replyAnonymously><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#0-зачем>0. Зачем?</a></li><li><a href=#1-идея>1. Идея</a><ul><li><a href=#11-платежный-канал>1.1. Платежный канал</a></li><li><a href=#12-сеть-платежных-каналов>1.2. Сеть платежных каналов</a></li><li><a href=#13-проблема-доверия>1.3. Проблема доверия</a></li></ul></li><li><a href=#2-смарт-контракты>2. Смарт-контракты</a><ul><li><a href=#21-авторизация>2.1. Авторизация</a></li><li><a href=#22-кооперация>2.2. Кооперация</a></li><li><a href=#23-сроки>2.3. Сроки</a></li></ul></li><li><a href=#3-реализация-канала>3. Реализация канала</a><ul><li><a href=#31-открытие-канала>3.1. Открытие канала</a></li><li><a href=#32-использование-канала>3.2. Использование канала</a></li></ul></li><li><a href=#4-lightning-network>4. Lightning Network</a><ul><li><a href=#41-платежный-канал-через-посредника>4.1. Платежный канал через посредника</a></li><li><a href=#42-маршрутизация>4.2. Маршрутизация</a></li><li><a href=#43-экономика-комиссий>4.3. Экономика комиссий</a></li><li><a href=#44-критика>4.4. Критика</a></li></ul></li><li><a href=#5-ln-сегодня>5. LN сегодня</a></li></ul></nav></div></aside></main></body></html>