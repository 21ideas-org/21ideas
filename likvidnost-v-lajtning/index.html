<!doctype html><html lang=ru dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Джейсон Лопп: уроки, полученные при управлении узлом маршрутизации в сети Lightning."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta name=lightning content="tony@bitcoin-herald.org"><meta property="og:title" content="Руководство по управлению ликвидностью в сети Lightning"><meta property="og:description" content="Джейсон Лопп: уроки, полученные при управлении узлом маршрутизации в сети Lightning."><meta property="og:type" content="article"><meta property="og:url" content="https://new.21ideas.org/likvidnost-v-lajtning/"><meta property="article:section" content="docs"><meta property="article:published_time" content="2021-08-07T00:00:00+00:00"><meta property="article:modified_time" content="2023-09-26T18:51:45+03:00"><title>Руководство по управлению ликвидностью в сети Lightning | 21ideas</title><link rel=manifest href=/manifest.json><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon media="(prefers-color-scheme: dark)" sizes=180x180 href=/apple-touch-icon-dark.png><link rel=icon type=image/png media="(prefers-color-scheme: dark)" sizes=32x32 href=/favicon-32x32-dark.png><link rel=icon type=image/png media="(prefers-color-scheme: dark)" sizes=16x16 href=/favicon-16x16-dark.png><link rel=stylesheet href=/book.min.28ed56dbaf62c62458610d4571301afda8aec7cd0354a3a2079fec22277448a3.css integrity="sha256-KO1W269ixiRYYQ1FcTAa/aiux80DVKOiB5/sIid0SKM=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/ru.search.min.1273675783b96c3f86c02e5a14c93e31dff80254789edf1c6e49dc5b67439ebf.js integrity="sha256-EnNnV4O5bD+GwC5aFMk+Md/4AlR4nt8cbkncW2dDnr8=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><picture><source srcset=/svg/logo_white.svg media="(prefers-color-scheme: dark)"><img src=/svg/logo_black.svg alt=Logo></picture>
<span>21ideas</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Поиск aria-label=Поиск maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/start/>Старт</a><ul></ul></li><li><input type=checkbox id=section-4f53cbff6ac5b0f9cfca5f1f9f3b991c class=toggle checked>
<label for=section-4f53cbff6ac5b0f9cfca5f1f9f3b991c class="flex justify-between"><a href=/theory/>Теория</a></label><ul><li><input type=checkbox id=section-c4ddad175f26bb1d35909363eff62296 class=toggle>
<label for=section-c4ddad175f26bb1d35909363eff62296 class="flex justify-between"><a href=/economics/>Экономика</a></label><ul><li><a href=/bitkoin-ne-vredit-okruzhayushej-srede/>Биткоин и окружающая среда</a></li><li><a href=/sem-setevyh-effektov-bitkoina/>Семь сетевых эффектов Биткоина</a></li><li><input type=checkbox id=section-a51542c01e6fb6da0be0947ec8232131 class=toggle>
<label for=section-a51542c01e6fb6da0be0947ec8232131 class="flex justify-between"><a href=/pzv/>Постепенно, затем внезапно</a></label><ul><li><a href=/pzv/postepenno-zatem-vnezapno/>Введение</a></li><li><a href=/pzv/bitkoin-nelzya-skopirovat/>Биткоин нельзя скопировать</a></li></ul></li></ul></li><li><input type=checkbox id=section-e83ea293497a2ab861101ccfc99a8ecc class=toggle>
<label for=section-e83ea293497a2ab861101ccfc99a8ecc class="flex justify-between"><a href=/security/>Безопасность</a></label><ul><li><a href=/kak-hranit-kljuchi/>Биткоин-кошельки. Зачем и как хранить свои приватные ключи</a></li></ul></li><li><input type=checkbox id=section-e9552bdc5e196adcf41f88d9180bebda class=toggle>
<label for=section-e9552bdc5e196adcf41f88d9180bebda class="flex justify-between"><a href=/privacy/>Приватность</a></label><ul><li><a href=/privacy/luchshie-praktiki/>Как сохранить приватность?</a></li><li><a href=/privacy/no-kyc/>Никаких KYC, берегите персональные данные</a></li></ul></li><li><input type=checkbox id=section-e49feff8bdc4c8d9840548f297831fbc class=toggle>
<label for=section-e49feff8bdc4c8d9840548f297831fbc class="flex justify-between"><a href=/protocol/>Протокол</a></label><ul><li><a href=/kto-kontroliruet-bitkoin-kor/>Кто контролирует Bitcoin Core?</a></li><li><a href=/vechnaja-borba/>Вечная борьба Биткоина</a></li><li><a href=/ob-udobstve-vzaimodejstvija-s-bitcoinom/>Об удобстве взаимодействия с Биткоином</a></li></ul></li><li><input type=checkbox id=section-8509d6019544d659ccbc67af32e91aea class=toggle>
<label for=section-8509d6019544d659ccbc67af32e91aea class="flex justify-between"><a href=/history/>История</a></label><ul><li><a href=/hal-finney/>Хэл Финни — жизнь и смерть легенды движения шифропанков</a></li><li><input type=checkbox id=section-51bacf4bb315fc63174fdbbc90ffb95d class=toggle>
<label for=section-51bacf4bb315fc63174fdbbc90ffb95d class="flex justify-between"><a href=/gf/>Генезис-файлы</a></label><ul><li><a href=/gf/genesis-intro/>Генезис-файлы. Пролог: день, когда криптография изменилась навсегда</a></li><li><a href=/gf/genesis-1/>Генезис-файлы. Часть I: eCash Дэвида Чаума и зарождение мечты шифропанков</a></li><li><a href=/gf/genesis-2/>Генезис-файлы. Часть II: Hashcash или как Адам Бэк разработал сердце Биткоина</a></li><li><a href=/gf/genesis-3/>Генезис-файлы. Часть III: Если у Биткоина был прототип, то это были b-money Вэя Дая</a></li><li><a href=/gf/genesis-4/>Генезис-файлы. Часть IV: Создавая Bit Gold, Сабо был в двух шагах от изобретения Биткоина</a></li><li><a href=/gf/genesis-5/>Генезис-файлы. Часть V: Как поиски цифровой наличности привели Хэла Финни к созданию RPOW (и не только)</a></li></ul></li></ul></li><li><input type=checkbox id=section-042f7e1a0906e66d4ceaeeb231b37175 class=toggle>
<label for=section-042f7e1a0906e66d4ceaeeb231b37175 class="flex justify-between"><a href=/philosophy/>Философия</a></label><ul><li><a href=/ne-shitcoin/>Биткоин, не щиткоин</a></li><li><a href=/neotemlemye-prava-sobstvennosti/>Неотъемлемые права собственности. Закон, язык, деньги и мораль Биткоина</a></li></ul></li><li><input type=checkbox id=section-66beb9b5ed04619b43509a5a9298b3a2 class=toggle>
<label for=section-66beb9b5ed04619b43509a5a9298b3a2 class="flex justify-between"><a href=/future/>Будущее</a></label><ul><li><input type=checkbox id=section-df24c55b3b01a044f159006399dd3f62 class=toggle>
<label for=section-df24c55b3b01a044f159006399dd3f62 class="flex justify-between"><a href=/ba/>Биткоин-астрономия</a></label><ul><li><a href=/ba/1/>Постгипербиткоинизация</a></li></ul></li></ul></li><li><input type=checkbox id=section-a71a3aee31fa8f939d269196bdc16bfd class=toggle checked>
<label for=section-a71a3aee31fa8f939d269196bdc16bfd class="flex justify-between"><a href=/lightning/>Лайтнинг</a></label><ul><li><a href=/chto-takoe-laitning/>Что такое Лайтнинг?</a></li><li><a href=/lajtning-adresa/>Лайтнинг-адреса</a></li><li><a href=/privatnost-v-lajtning/>Приватность в сети Lightning</a></li><li><a href=/likvidnost-v-lajtning/ class=active>Руководство по управлению ликвидностью в сети Lightning</a></li></ul></li></ul></li><li><input type=checkbox id=section-a6b5e5f811434cb992fdebac0e1d7718 class=toggle>
<label for=section-a6b5e5f811434cb992fdebac0e1d7718 class="flex justify-between"><a href=/practice/>Практика</a></label><ul><li><input type=checkbox id=section-5a7a56ff2c706814b0747555f55b45b2 class=toggle>
<label for=section-5a7a56ff2c706814b0747555f55b45b2 class="flex justify-between"><a href=/practice/buy/>Покупка</a></label><ul><li><a href=/hodl-hodl/>Покупка биткоина без KYC на Hodl Hodl</a></li></ul></li><li><input type=checkbox id=section-a2a499e8fa40193bb85003cabaff5d49 class=toggle>
<label for=section-a2a499e8fa40193bb85003cabaff5d49 class="flex justify-between"><a href=/practice/hodl/>Хранение</a></label><ul><li><a href=/electrum/>Кошелек Электрум</a></li><li><a href=/blue/>Кошелек Blue</a></li><li><a href=/seedsigner/>SeedSigner: оффрлайн-крепость для ваших биткоинов</a></li></ul></li><li><input type=checkbox id=section-4e34fd6dae27eeab9274b5e370a300a7 class=toggle>
<label for=section-4e34fd6dae27eeab9274b5e370a300a7 class="flex justify-between"><a href=/practice/interact/>Взаимодействие</a></label><ul><li><a href=/practice/guide/>Используем биткоин</a></li></ul></li><li><input type=checkbox id=section-0af442a82e8087438ae3e5d932bfcd3c class=toggle>
<label for=section-0af442a82e8087438ae3e5d932bfcd3c class="flex justify-between"><a href=/practice/lightning/>Лайтнинг на практике</a></label><ul><li><a href=/phoenix/>Кошелек Phoenix</a></li><li><a href=/lnbits/>LNbits</a></li></ul></li></ul></li><li><input type=checkbox id=section-4f9efbc916a788429edff50248f79330 class=toggle>
<label for=section-4f9efbc916a788429edff50248f79330 class="flex justify-between"><a href=/rabbithole/>Кроличья нора</a></label><ul><li><input type=checkbox id=section-dd34bc6fc687d6e6fb62acabc34277a6 class=toggle>
<label for=section-dd34bc6fc687d6e6fb62acabc34277a6 class="flex justify-between"><a href=/books/>Книги</a></label><ul><li><input type=checkbox id=section-e3198834b11fdb517332c04453209400 class=toggle>
<label for=section-e3198834b11fdb517332c04453209400 class="flex justify-between"><a href=/izobretaem-bitkoin/>Изобретаем Биткоин</a></label><ul><li><a href=/izobretaem-bitkoin/vstuplenie/>Вступление</a></li></ul></li><li><input type=checkbox id=section-f289993761aca4a4b180363fe368f984 class=toggle>
<label for=section-f289993761aca4a4b180363fe368f984 class="flex justify-between"><a href=/suverenitet-posredstvom-matematiki/>Суверенитет посредством математики</a></label><ul><li><a href=/suverenitet-posredstvom-matematiki/intro/>Предисловие</a></li><li><a href=/suverenitet-posredstvom-matematiki/glava-1/>Глава 1: ВСЯ НАША ЖИЗНЬ — ТОРГОВЛЯ</a></li><li><a href=/suverenitet-posredstvom-matematiki/glava-2/>Глава 2: ФИНАНСОВЫЙ АТЕИЗМ</a></li><li><a href=/suverenitet-posredstvom-matematiki/glava-3/>Глава 3: ДОВЕРЧИВОСТЬ</a></li><li><a href=/suverenitet-posredstvom-matematiki/glava-4/>Глава 4: НЕПОРОЧНОЕ ЗАЧАТИЕ</a></li><li><a href=/suverenitet-posredstvom-matematiki/glava-5/>Глава 5: PROOF OF WORK</a></li><li><a href=/suverenitet-posredstvom-matematiki/glava-6/>Глава 6: РЕДКОСТЬ</a></li><li><a href=/suverenitet-posredstvom-matematiki/glava-7/>Глава 7: ХОДЛ ОН</a></li><li><a href=/suverenitet-posredstvom-matematiki/glava-8/>Глава 8: ИЗМЕНЕНИЕ ПРАВИЛ</a></li><li><a href=/suverenitet-posredstvom-matematiki/glava-9/>Глава 9: ДЕНЬГИ КАК АКСЕЛЕРАТОР</a></li><li><a href=/suverenitet-posredstvom-matematiki/glava-10/>Глава 10: ОКРУЖАЮЩАЯ СРЕДА</a></li><li><a href=/suverenitet-posredstvom-matematiki/glava-11/>Глава 11: НОВАЯ ФОРМА ЖИЗНИ</a></li><li><a href=/suverenitet-posredstvom-matematiki/glava-12/>Глава 12: БУДУЩЕЕ</a></li><li><a href=/suverenitet-posredstvom-matematiki/mysli/>РАЗМЫШЛЕНИЯ</a></li></ul></li></ul></li><li><a href=/videos/>Видео</a><ul></ul></li></ul></li><li><input type=checkbox id=section-d90442343f58c582906ebc7e255e7116 class=toggle>
<label for=section-d90442343f58c582906ebc7e255e7116 class="flex justify-between"><a href=/contribute/>Принять участие</a></label><ul><li><a href=/syntax/>Оформление статей</a></li><li><a href=/github/>Как добавить статью?</a></li><li><a href=/obsidian/>Публикация статей через Obsidian</a></li></ul></li></ul><ul><li><a href=/posts/>Блог</a></li><li><a href=https://github.com/21ideas-org/21ideas.org target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Руководство по управлению ликвидностью в сети Lightning</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><a href=#уроки-полученные-при-управлении-узлом-маршрутизации-в-сети-lightning>Уроки, полученные при управлении узлом маршрутизации в сети Lightning.</a></li></ul></li><li><a href=#ваша-прибыль-может-варьироваться>Ваша прибыль может варьироваться</a></li><li><a href=#множество-переменных>Множество переменных</a></li><li><a href=#принятие-решения-по-открытию-каналов>Принятие решения по открытию каналов</a></li><li><a href=#экономия-на-ончейн-комиссиях-за-открытие-канала-с-помощью-сгруппированных-открытий-batch-opens>Экономия на ончейн-комиссиях за открытие канала с помощью сгруппированных открытий (Batch Opens)</a></li><li><a href=#открытие-каналов-с-взаимным-финансированием>Открытие каналов с взаимным финансированием</a></li><li><a href=#ребалансировка-каналов>Ребалансировка каналов</a></li><li><a href=#управление-политикой-канала>Управление политикой канала</a></li><li><a href=#покупка-входящей-ликвидности>Покупка входящей ликвидности</a></li><li><a href=#lightning-loop>Lightning Loop</a></li><li><a href=#узел-lightning-loop>Узел Lightning Loop</a></li><li><a href=#высвобождение-незадействованного-капитала>Высвобождение незадействованного капитала</a></li><li><a href=#результаты>Результаты</a></li><li><a href=#мысли-вслух>Мысли вслух</a></li><li><a href=#что-дальше>Что дальше?</a></li></ul></nav></aside></header><article class=markdown><p><img src=/img/lln-263.jpg alt=cover></p><h2 id=уроки-полученные-при-управлении-узлом-маршрутизации-в-сети-lightning>Уроки, полученные при управлении узлом маршрутизации в сети Lightning.
<a class=anchor href=#%d1%83%d1%80%d0%be%d0%ba%d0%b8-%d0%bf%d0%be%d0%bb%d1%83%d1%87%d0%b5%d0%bd%d0%bd%d1%8b%d0%b5-%d0%bf%d1%80%d0%b8-%d1%83%d0%bf%d1%80%d0%b0%d0%b2%d0%bb%d0%b5%d0%bd%d0%b8%d0%b8-%d1%83%d0%b7%d0%bb%d0%be%d0%bc-%d0%bc%d0%b0%d1%80%d1%88%d1%80%d1%83%d1%82%d0%b8%d0%b7%d0%b0%d1%86%d0%b8%d0%b8-%d0%b2-%d1%81%d0%b5%d1%82%d0%b8-lightning>#</a></h2><p><em>Оригинал:</em></p><table><thead><tr><th style=text-align:center><img src=/img/lln-263.jpg alt=lln-orig></th></tr></thead><tbody><tr><td style=text-align:center><em><a href=https://blog.lopp.net/lightning-network-liquidity-management-guide>Lightning Liquidity Management Guide</a></em></td></tr></tbody></table><blockquote class="book-hint btc">Перевод подготовлен <a href=https://snort.social/p/npub10awzknjg5r5lajnr53438ndcyjylgqsrnrtq5grs495v42qc6awsj45ys7>Тони⚡️</a>. <a href=/contribute/>Поддержать проект</a>.</blockquote><p>С тех пор как люди начали запускать узлы Lightning в mainnet в начале 2018 года, некоторые задавались вопросом: какую реальную прибыль можно ожидать от размещения капитала в маршрутизационной ноде? Ник Бхатия подробно описал свою теорию возможных вариантов развития событий:</p><table><thead><tr><th style=text-align:center><img src=/img/lln-264.jpeg alt=ln-rate></th></tr></thead><tbody><tr><td style=text-align:center><em><a href=https://timevalueofbtc.medium.com/the-time-value-of-bitcoin-and-lnrr-e0c435931bd8>The Time Value of Bitcoin and LNRR</a></em></td></tr></tbody></table><p>Но, как мы узнали за эти годы, ROI (возврат инвестиций/прибыль от инвестиций) включает в себя гораздо больше, чем просто вложение капитала в каналы Lightning.</p><blockquote class=twitter-tweet><p lang=en dir=ltr>Lightning routing is a multi-faceted competitive system. It’s not just about capital, a brute force deployment of capital will cripple ROI. The system models a distributed predictive cache. Available capital is a factor but so is intelligent capital placement, reliability, speed.</p>&mdash; Alex Bosworth (@alexbosworth) <a href="https://twitter.com/alexbosworth/status/994603452310278144?ref_src=twsrc%5Etfw">May 10, 2018</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>В начале 2021 года я решил попытаться определить, насколько хорошо я смогу управлять узлом с целью получения прибыли за счет маршрутизации средств.</p><p>Я следовал процессу, описанному в моем предыдущем блог посте, поясняющем как создать свой узел, функционирующий исключительно через Tor:</p><table><thead><tr><th style=text-align:center><img src=/img/lln-265.png alt=ln-tor></th></tr></thead><tbody><tr><td style=text-align:center><em><a href=https://blog.lopp.net/tor-only-bitcoin-lightning-guide>Tor-Only Bitcoin & Lightning Guide</a></em></td></tr></tbody></table><p>Запустить программное обеспечение было проще простого. Далее мне нужно было понять, как наиболее эффективно разместить свой капитал.</p><h1 id=ваша-прибыль-может-варьироваться>Ваша прибыль может варьироваться
<a class=anchor href=#%d0%b2%d0%b0%d1%88%d0%b0-%d0%bf%d1%80%d0%b8%d0%b1%d1%8b%d0%bb%d1%8c-%d0%bc%d0%be%d0%b6%d0%b5%d1%82-%d0%b2%d0%b0%d1%80%d1%8c%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d1%82%d1%8c%d1%81%d1%8f>#</a></h1><p>К сожалению, невозможно написать руководство, которое предоставило бы простые инструкции в стиле: &ldquo;Подключитесь к этим узлам и получайте комиссионные&rdquo;. Необходимо рассматривать Lightning Network как конкурентный рынок, предлагающий эффективное передвижение капитала. Как и в случае с определенной торговой стратегией, если все начнут прибегать к одним и тем же техникам, все преимущества, присущие этой стратегии, исчезнут, и это создаст возможности для других участников торговать против нее. Если все будут строить одни и те же мосты для перемещения капитала, это превратится в гонку на износ в конкуренции за комиссионные, и для других операторов будет разумнее &ldquo;противодействовать&rdquo; этой стратегии, строя мосты в другом месте.</p><h1 id=множество-переменных>Множество переменных
<a class=anchor href=#%d0%bc%d0%bd%d0%be%d0%b6%d0%b5%d1%81%d1%82%d0%b2%d0%be-%d0%bf%d0%b5%d1%80%d0%b5%d0%bc%d0%b5%d0%bd%d0%bd%d1%8b%d1%85>#</a></h1><p>Вы, наверное, заметили, что эта статья получилась очень длинной. Причина тому — наличие множества различных вопросов, которые необходимо учитывать при эксплуатации узла Lightning Network с целью максимизации маршрутизации. К ним относятся:</p><ul><li>Размещение капитала</li><li>Комиссии за маршрутизацию</li><li>Минимизация ончейн-комиссий</li><li>Ваша общая входящая/исходящая емкость</li><li>Поддержание пропускной способности маршрутизации (ребалансировка / Submarine Swaps)</li><li>Входящая / исходящая емкость пользователей</li><li>Безотказность / время работы / здоровье узлов</li><li>Безотказность / нагрузка / сетевое подключение вашего узла</li></ul><h1 id=принятие-решения-по-открытию-каналов>Принятие решения по открытию каналов
<a class=anchor href=#%d0%bf%d1%80%d0%b8%d0%bd%d1%8f%d1%82%d0%b8%d0%b5-%d1%80%d0%b5%d1%88%d0%b5%d0%bd%d0%b8%d1%8f-%d0%bf%d0%be-%d0%be%d1%82%d0%ba%d1%80%d1%8b%d1%82%d0%b8%d1%8e-%d0%ba%d0%b0%d0%bd%d0%b0%d0%bb%d0%be%d0%b2>#</a></h1><p>Алекс Босворт предоставляет подробное руководство <a href=https://github.com/alexbosworth/run-lnd/blob/master/LIQUIDITY.md>в этом документе</a>.</p><p>Открыть каналы Lightning очень просто — подавляющее большинство узлов в сети примут входящий канал практически любой емкости. Таким образом, есть опасность заблокировать капитал у плохо функционирующего узла, который не обрабатывает значительного количества платежей. А если ваш <em>пир</em> (держатель узла, с которым вы открыли канал) перестает отвечать, закрытие канала может привести к тому, что ваш капитал окажется в бездействии на несколько недель.</p><p>В ходе моих первоначальных экспериментов я обнаружил, что некоторые узлы просто не маршрутизируются, возможно, потому, что у них недостаточно ликвидности, направленной другим узлами. Довольно сложно сказать, каков будет статус пиров, не исследуя различные маршруты, проходящие через них, что изначально требует открытия канала. Я ожидаю, что в будущем появятся сервисы, которые помогут решить эту проблему и дадут больше информации о состоянии ликвидности того или иного узла.</p><p>Что бы вы ни делали, <strong>избегайте использования автопилота lnd</strong>; он просто подключается к крупным популярным узлам. Аналогично, похоже, что многие просто заходят на Lightning Terminal или 1ML и подключаются к узлам с самым высоким рейтингом. Это может звучать нелогично, но такая стратегия не является выигрышной, если вы хотите, чтобы ваш узел направлял большое количество платежей. Скорее, <strong>вы должны стремиться к созданию новых мостов</strong>, связывая между собой узлы, которым в противном случае пришлось бы совершить много <em>хопов</em> (перенаправлений/прыжков) для маршрутизации друг к другу.</p><p>Еще одна проблема, с которой я сталкивался, — это использование оценки BOS для решения с какими узлами открывать каналы. Алекс Босворт, который написал алгоритм подсчета баллов, сказал мне, что он не был задуман как система подбора узлов маршрутизации/оценки качества.</p><p>Я использовал инструмент подбора узлов (<a href=https://moneni.com/nodematch>node match tool</a>), чтобы выяснить, какие узлы больше всего повысят мою центрированность. Однако я бы еще раз предостерег от слепого открытия каналов с узлами, получившими наивысший рейтинг. Прежде чем открыть канал с одним из рекомендованных узлов, я проверяю его на <a href=https://terminal.lightning.engineering/>Lightning Terminal</a>, чтобы убедиться в его стабильности. Затем я проверяю его на <a href=https://1ml.com/>1ML</a>, чтобы убедиться, что они устанавливают разумную политику комиссионных сборов.</p><p><img src=/img/lln-266.png alt=ln-peers></p><p>Чтобы получить альтернативный взгляд на то, как повысить центрированность узла, я использовал скрипт Gridflare &ldquo;<a href=https://github.com/Gridflare/lndpytools/blob/main/improvecentrality.py>improve centrality</a>&rdquo; от <a href=https://github.com/Gridflare/lndpytools>lndpytools</a>. Он, конечно, не так удобен в использовании, как другие веб-инструменты, так как требует получения полного дампа сетевого графа с вашего узла, переноса его на настольный компьютер / ноутбук, а затем запуска анализа на этом json-файле.</p><p><img src=/img/lln-267.png alt=improve-centrality></p><p>Мой опыт подсказывает, что большинство &ldquo;высокосвязанных&rdquo; узлов с 500+ каналами, как правило, нестабильны и поэтому не направляют много платежей. Я подозреваю, что они слишком сильно нагружают свое оборудование. Однако другие пользователи сообщают о другом опыте — ваша прибыль может варьироваться!</p><p>Если вы можете себе это позволить, не создавайте каналы размером менее 10M (миллионов) сат. Имейте в виду, что максимальный размер платежа по умолчанию составляет чуть более 4M сат. Поэтому, если вы хотите иметь возможность поддерживать каналы, которые могут маршрутизировать максимальный размер платежа в любом направлении, вам нужно, по крайней мере, удвоить этот объем, а лучше еще сильнее его увеличить, поскольку довольно сложно иметь достаточно входящей ликвидности и достаточно исходящей ликвидности на обеих сторонах канала. Если вы не пытаетесь управлять узлом маршрутизации, это не так важно. Также можно быть узлом маршрутизации больших объемов платежей с меньшими каналами — скорее всего, вам придется делать больше ребалансировок — но все же желательно, чтобы пропускная способность вашего канала была как можно выше.</p><p>Если вы не можете позволить себе каналы в 10М сат, я бы посоветовал минимум 1М сат. Моя нода переслала 400 платежей за последние несколько месяцев, и средняя сумма пересылки составила 420,000 сат — около $150. Таким образом, вам потребуется почти идеально сбалансированный канал в 1М сат, чтобы иметь возможность переслать один средний платеж. Надеюсь, динамика изменится, когда все больше и больше кошельков начнут использовать <a href=https://t.me/bitcoin_translated/1427>многоходовые</a> (multi-path) платежи.</p><p>В lnd вы можете предотвратить входящие каналы меньше определенного размера, введя следующую строку в lnd.conf:</p><p>minchansize=1000000</p><p>Не все узлы позволят вам открыть с ними канал, и они не объяснят, почему отклоняют ваш запрос на открытие. Например, я попытался открыть канал с узлом Zap и получил отказ, даже когда я попробовал максимальный (по умолчанию) размер канала.</p><p>$ lncli openchannel &ndash;node_key 03b428ba4b48b524f1fa929203ddc2f0971c2077c2b89bb5b22fd83ed82ac2f7e1 &ndash;local_amt 16000000 &ndash;sat_per_vbyte 1<br>[lncli] rpc error: code = Unknown desc = received funding error from 03b428ba4b48b524f1fa929203ddc2f0971c2077c2b89bb5b22fd83ed82ac2f7e1: err=channel rejected</p><p>Перед открытием канала необходимо попытаться определить, какова будет политика маршрутизации контрагента. Например, LNBIG имеет довольно высокие комиссии 175ppm — какой смысл платить за входящую ликвидность на ваш узел, если люди будут избегать его использования из-за высоких комиссий?</p><p>Некоторые узлы имеют абсурдно высокие комиссии за маршрутизацию; например, я заметил, что на узлах OKEX и OKCoin базовая комиссия установлена на уровне 1М сатоши — $400! Я говорил об этом с генеральным директором OKCoin, и он сказал, что это сделано специально, чтобы препятствовать маршрутизации; я предложил им изменить конфигурацию, чтобы просто отклонять открытие входящих каналов.</p><h1 id=экономия-на-ончейн-комиссиях-за-открытие-канала-с-помощью-сгруппированных-открытий-batch-opens>Экономия на ончейн-комиссиях за открытие канала с помощью сгруппированных открытий (Batch Opens)
<a class=anchor href=#%d1%8d%d0%ba%d0%be%d0%bd%d0%be%d0%bc%d0%b8%d1%8f-%d0%bd%d0%b0-%d0%be%d0%bd%d1%87%d0%b5%d0%b9%d0%bd-%d0%ba%d0%be%d0%bc%d0%b8%d1%81%d1%81%d0%b8%d1%8f%d1%85-%d0%b7%d0%b0-%d0%be%d1%82%d0%ba%d1%80%d1%8b%d1%82%d0%b8%d0%b5-%d0%ba%d0%b0%d0%bd%d0%b0%d0%bb%d0%b0-%d1%81-%d0%bf%d0%be%d0%bc%d0%be%d1%89%d1%8c%d1%8e-%d1%81%d0%b3%d1%80%d1%83%d0%bf%d0%bf%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%bd%d1%8b%d1%85-%d0%be%d1%82%d0%ba%d1%80%d1%8b%d1%82%d0%b8%d0%b9-batch-opens>#</a></h1><p>Если вы запускаете новый узел, вам будет необходимо открыть много каналов. Рассмотрите вариант сгруппированных/пакетных открытий каналов с помощью командной строки:</p><p>Пакетное открытие транзакции с помощью balanceofsatoshi (bos) и Electrum Desktop. Ниже приведено краткое описание процесса, но этот шаг включает в себя ончейн-транзакцию и, следовательно, возможную потерю средств, если вы допустите ошибку. На сайте Джестофера есть подробное руководство: <a href=http://satbase.org/bos-open/>http://satbase.org/bos-open/</a>.</p><ol><li>В Electrum Desktop перейдите в Tools > Settings, во вкладке &ldquo;Transactions&rdquo; активируйте &ldquo;Advanced preview”. Затем в Tools откройте диалоговое окно “Pay to many”.</li><li>На вашем узле, как пользователь bos, в интерфейсе командной строки введите следующую команду: bos open &lt;node pubkey 1> &ndash;amount &lt;channel size in sats 1> &lt;pubkey 2> &ndash;amount &lt;channel size 2> &lt;pubkey 3> &ndash;amount &lt;channel size 3> &lt;pubkey 4> &ndash;amount &lt;channel size 4> &lt;pubkey 5> &ndash;amount &lt;channel size 5> &lt;pubkey 6> &ndash;amount &lt;channel size 6>  После нажатия Enter запустится счетчик на 10 минут, и вам нужно будет выполнить шаги с 3 по 5 в течение этих 10 минут. Следите за тем, чтобы не использовать Ctrl+C после запуска таймера! Если вы хотите отменить процесс и таймер, просто нажмите Enter в интерфейсе командной строки.</li><li>Не вводите никаких других команд в CLI, а просто скопируйте вывод команды &lsquo;bos open&rsquo;, который будет представлять собой список ончейн-адресов и сумму в биткоинах через запятую. Этот формат совместим с опцией Electrum &lsquo;pay to many&rsquo;.</li><li>В Electrum вставьте этот список в диалоговое окно pay-to-many, сохраните транзакцию, нажмите &lsquo;Pay&rsquo;, установите фиксированную комиссию как можно ниже, <a href=https://mempool.space/>основываясь на текущих условиях мемпула</a>. Убедитесь, что флажок RBF <strong>НЕ</strong> установлен. Затем нажмите &lsquo;Finalize&rsquo; и &lsquo;Sign&rsquo;, используя ваш аппаратный кошелек (или кошелек Electrum, если не используете аппаратный кошелек), но <strong>НЕ</strong> транслируйте транзакцию! Это сделает balanceofsatoshi.</li><li>После того, как транзакция будет финализирована и подписана, скопируйте подписанную необработанную транзакцию, вставьте ее в интерфейс командной строки и нажмите &lsquo;Enter&rsquo;. Через несколько секунд или минут bos отобразит идентификатор транзакции (transaction ID). Затем вы можете использовать собственный блокчейн-эксплорер узла для проверки статуса вашей пакетной транзакции.</li></ol><h1 id=открытие-каналов-с-взаимным-финансированием>Открытие каналов с взаимным финансированием
<a class=anchor href=#%d0%be%d1%82%d0%ba%d1%80%d1%8b%d1%82%d0%b8%d0%b5-%d0%ba%d0%b0%d0%bd%d0%b0%d0%bb%d0%be%d0%b2-%d1%81-%d0%b2%d0%b7%d0%b0%d0%b8%d0%bc%d0%bd%d1%8b%d0%bc-%d1%84%d0%b8%d0%bd%d0%b0%d0%bd%d1%81%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5%d0%bc>#</a></h1><p>Если у вас есть друг, который готов с вами сотрудничать, вы можете немного сэкономить на ребалансировке/циклировании, инициализировав уже сбалансированный канал. Ознакомьтесь с необходимыми шагами для Алисы и Боба, использующими bos CLI:</p><p>(NODE 1: Bob)</p><p>(0) Run: bos open-balanced-channel</p><p>(1) enter remote node public key</p><p>(2) enter full channel size</p><p>(3) enter fee rate</p><p>Open a new terminal window.</p><p>(4) Run: bos fund &ndash;fee-rate &lt;fee> &lt;address> &lt;amount in sats></p><p>Copy the signed_transaction and go back to 1st window and paste</p><p>(5) paste the signed_transaction to bos prompt in 1st window</p><p>(NODE 2: Alice)</p><p>(0) Run: bos open-balanced-channel (it should see the request from node1 at this point)</p><p>(1) agree with funding rate (y/n)</p><p>Open a new terminal window.</p><p>(2) Run: bos fund &ndash;fee-rate &lt;fee> &lt;address> &lt;amount></p><p>Copy the signed_transaction and go back to 1st window and paste</p><p>(3) paste the signed_transaction to bos prompt in 1st window</p><p>(4) hit enter and this should work.</p><p>check via: lncli pendingchannels</p><h1 id=ребалансировка-каналов>Ребалансировка каналов
<a class=anchor href=#%d1%80%d0%b5%d0%b1%d0%b0%d0%bb%d0%b0%d0%bd%d1%81%d0%b8%d1%80%d0%be%d0%b2%d0%ba%d0%b0-%d0%ba%d0%b0%d0%bd%d0%b0%d0%bb%d0%be%d0%b2>#</a></h1><p>В некоторых случаях у меня не получалось ребалансировать канал из-за недостаточной ликвидности. Если вы заметили, что канал никогда не удается ребалансировать и он никогда не используется для маршрутизации средств, вы можете рассмотреть вариант его закрытия и распределения капитала в другом месте.</p><p>Перед ребалансировкой каналов вы должны убедиться, что в этом есть экономический смысл. В противном случае вы просто попадете в петлю постоянной ребалансировки каналов, поскольку они редко остаются идеально сбалансированными. Слепая ребалансировка в поисках идеального баланса почти наверняка в конечном итоге обойдется вам дороже из-за комиссионных, чем вы заработаете на маршрутизации платежей. К счастью, в &lsquo;bos&rsquo; есть опция &ndash;dryrun, позволяющая узнать, какой будет комиссия.</p><p>Вы можете использовать bos для автоматической ребалансировки, но для того, чтобы убедиться, что вы не проводите неэкономичную ребалансировку, вам нужно установить вашу максимальную ставку комиссии на минимальную ставку комиссии / 2. Вы можете добиться этого, добавив следующую строку в /etc/crontab:</p><p>*/10 * * * * * jameson /path/to/bos rebalance &ndash;max-fee-rate 5</p><p>В конце концов я наткнулся на инструмент <a href=https://github.com/C-Otto/rebalance-lnd>rebalance-lnd</a> Карстена Отто. Мне нравится этот инструмент для ребалансировки, потому что он делает дополнительный шаг в определении того, имеет ли данный маршрут ребалансировки экономический смысл.</p><p>Вот как рассчитывается экономическая целесообразность ребалансировки:</p><p>Допустим, у вашего узла есть два канала, для которых необходимо оценить ребалансировку — один на Bitfinex с 10M сат на вашей стороне и ставкой комиссии 1,000 ppm. У вашего узла также открыт канал с LOOP и взимает 5,000 ppm за пересылку средств. К сожалению, ваша сторона канала практически пуста.</p><p>Возможно, хорошей идеей будет перебросить средства с канала Bitfinex на канал LOOP. Если вы сделаете это для ребалансировки 4M сат, это будет означать следующее:</p><ol><li>После ребалансировки останется 6M сат, которые можно будет в последующем протолкнуть на сторону Bitfinex. Вы не заработаете 4M * 1,000 ppm = 4,000 сат за перевод средств, которые вы вывели со своей стороны канала в рамках ребалансировки в LOOP. Это цена упущенной возможности, которую вы заплатили.</li><li>Вы также должны оплатить все транзакционные издержки ребалансировки; это ваши прямые издержки.</li><li>Если вам повезет, вы сможете отправить эти 4M sat в LOOP и заработать 4M * 5,000 ppm = 20,000 sat. Это ваш потенциальный будущий доход.</li></ol><p>Транзакция ребалансировки имеет экономический смысл только в том случае, если потенциальный заработок превышает сумму альтернативных издержек и прямых затрат.</p><p>Но я быстро обнаружил следующий недостаток: ребалансировка обычно не стоит того. Похоже, что менее 5% моих попыток ребалансировки выполняются таким образом.</p><p>Я установил cronjob для запуска случайной ребалансировки каждые 5 минут, добавив следующую строку в /etc/crontab:</p><p>*/5 * * * * * jameson /path/to/rebalance.py &ndash;to -1</p><p>На моем узле открыто несколько десятков каналов, но в любой момент времени только около 25% из них нуждаются в ребалансировке, согласно инструменту rebalance-lnd, который по умолчанию пытается сохранить по крайней мере 1M сат на каждой стороне канала. Эти значения по умолчанию вряд ли будут оптимальными для вашей ситуации. Запуская случайную попытку ребалансировки каждые 5 минут, я ожидаю, что каждый канал, нуждающийся в ребалансировке, будет пытаться ребалансироваться дважды в час.</p><p><strong>Предупреждение:</strong> <em>это может дорого обойтись, если ваши комиссионные ставки за каналы будут нереально высокими, а в будущем вы их снизите! Убедитесь, что вы понимаете последствия автоматизации действий, что стоит денег.</em></p><p><strong>Pro Tip:</strong> После того, как я в течение недели запускал ребалансировку каждые 5 минут, я узнал, что она заполняет различные панели управления тоннами неоплаченных счетов с истекшим сроком действия. Чтобы снизить эффект этой проблемы, я предлагаю установить следующие две конфигурации lnd:</p><p>gc-canceled-invoices-on-startup=true<br>gc-canceled-invoices-on-the-fly=true</p><h1 id=управление-политикой-канала>Управление политикой канала
<a class=anchor href=#%d1%83%d0%bf%d1%80%d0%b0%d0%b2%d0%bb%d0%b5%d0%bd%d0%b8%d0%b5-%d0%bf%d0%be%d0%bb%d0%b8%d1%82%d0%b8%d0%ba%d0%be%d0%b9-%d0%ba%d0%b0%d0%bd%d0%b0%d0%bb%d0%b0>#</a></h1><p>В конце концов, я наткнулся на <a href=http://bc1q2q74hl6k2lhm6nzfa9t8z64m4zxqt3xa5ng0t3/>charge-lnd</a>, который является инструментом для автоматического динамического изменения платы за маршрутизацию на моих каналах. Стоит отметить, что это далеко не идеальный инструмент, потому что, к сожалению, мы можем устанавливать только исходящие комиссии для каналов. Это ограничение протокола Lightning, а не инструмента; вы можете прочитать больше о дебатах по поводу поддержки платы за входящие каналы <a href=https://github.com/lightningnetwork/lightning-rfc/issues/835>в этой теме на github</a>.</p><p>Первоначально, в течение первых нескольких месяцев работы, я установил все тарифные политики для каналов:</p><p>base_fee_msat: 5000<br>fee_ppm: 2000</p><p>Эти тарифы на порядок выше, чем по умолчанию; я просто хотел посмотреть, клюнут ли пользователи сети. Однако мой узел лишь изредка направлял средства с такими комиссиями. Предположительно, либо мои комиссии были слишком высокими, либо мой узел был плохо расположен на сетевом графике.</p><p>Позже я установил следующую конфигурацию для charge-lnd:</p><p>[proportional]<br>chan.min_ratio = 0<br>chan.max_ratio = 1<br>strategy = proportional<br>base_fee_msat = 1000<br>min_fee_ppm = 10<br>max_fee_ppm = 2000</p><p>И установил cronjob для ежечасного запуска charge-lnd, добавив следующую строку в /etc/crontab:</p><p>0 * * * * * jameson /path/to/charge-lnd -c /path/to/charge.config</p><p>В течение 48 часов после включения этого динамического управления политиками я увидел, что мой узел начал маршрутизировать больше платежей.</p><p>Вы не должны запускать этот скрипт чаще, чем раз в час, поскольку эти обновления распространяются относительно медленно (1 минута на хоп/прыжок), и если вы будете менять тарифы слишком часто, удаленные узлы, которые решат маршрутизировать через вас, будут часто получать ошибки FEE_INSUFFICIENT и, возможно, занесут ваши каналы или узел в черный список на несколько часов. Также желательно уменьшить трафик сплетен (gossip traffic) в сети.</p><p>Через пару месяцев я все еще наблюдал только спорадическую маршрутизацию, поэтому я изменил значения комиссий на:</p><p>min_fee_ppm = 2<br>max_fee_ppm = 200</p><p>Стоит отметить, что использование динамического менеджера политики каналов несколько противоречит логике, используемой инструментом rebalance-lnd — он предполагает, что плата за канал останется неизменной в обозримом будущем, когда рассчитывает альтернативную стоимость, которую вы платите, перемещая ликвидность. Например, если rebalance-lnd использует текущую комиссионную ставку вашего канала, чтобы решить, когда проводить ребалансировку, а charge lnd меняет ставки комиссии, rebalance-lnd примет решение, которое имеет смысл для него при ставке комиссии A, но позже может появиться charge lnd и изменить ставку комиссии на B, что сделает логику rebalance-lnd для ставки комиссии A недействительной. Похоже, что rebalance-lnd должен знать конфигурацию charge lnd и исторический поток средств через канал, чтобы лучше предсказать будущий доход от комиссии.</p><h1 id=покупка-входящей-ликвидности>Покупка входящей ликвидности
<a class=anchor href=#%d0%bf%d0%be%d0%ba%d1%83%d0%bf%d0%ba%d0%b0-%d0%b2%d1%85%d0%be%d0%b4%d1%8f%d1%89%d0%b5%d0%b9-%d0%bb%d0%b8%d0%ba%d0%b2%d0%b8%d0%b4%d0%bd%d0%be%d1%81%d1%82%d0%b8>#</a></h1><p>Получение (и поддержание) входящей ликвидности — одна из самых больших проблем в работе узла маршрутизации.</p><p>По состоянию на 5 июля 2021 года стоимость покупки максимального количества входящей ликвидности (16,7 млн сат / $5,650) для канала через определенные сервисы составляет:</p><ul><li><a href=https://www.bitrefill.com/buy/lightning-channel/>Bitrefill</a>: 199,021 сат / $67</li><li><a href=https://yalls.org/about/>Y&rsquo;alls</a>: 150,000 сат / $50.44</li><li><a href=https://lnbig.com/#/open-channel>LNBIG</a>: 24,101 сат / $8.30</li><li><a href=https://github.com/lightninglabs/loop>Loop</a>: 26,165 сат / $8.81</li><li><a href=https://github.com/lightninglabs/pool>Pool</a>: неизвестно (аукционы проводятся вслепую)</li></ul><p>Вы также можете использовать следующие сервисы для открытия канала и получения ответного канала или получения средств ончейн:</p><ul><li><a href=https://lightningconductor.net/channels>https://lightningconductor.net/channels</a></li><li><a href=https://ln2me.com/>https://ln2me.com/</a></li></ul><p>Эти методы требуют доверия к сервису в возврате средств. Решение, требующее меньшего доверия, заключается в использовании функции bos dual-funded channel open (двустороннее открытие канала), о которой говорилось ранее, хотя для этого необходимо найти контрагента, который достаточно подкован, чтобы использовать balanceofsatoshis CLI.</p><p>Если у вас есть аккаунт на бирже, которая поддерживает депозиты Lightning, вы можете отправить на биржу, а затем выполнить вывод средств ончейн, увеличив таким образом свою входящую ликвидность. Несколько лет назад я <a href="https://www.youtube.com/watch?v=HtU7ZlxvLL4&amp;feature=youtu.be&amp;t=273">проводил презентацию</a> о важности подключения бирж к Lightning Network для повышения ликвидности в сети.</p><p>Наконец, вы можете использовать различные каналы связи для координации обмена ликвидностью.</p><ul><li><a href=https://lightningnetwork.plus/>https://lightningnetwork.plus/</a></li><li><a href="https://www.reddit.com/r/TheLightningNetwork/search?sort=new&amp;restrict_sr=on&amp;q=flair%3ALiquidity%2BSwaps">Reddit Lightning Triangles</a></li><li><a href=https://t.me/theRingsOfFire>Rings of Fire</a></li><li><a href=https://t.me/Plebnet>Plebnet</a></li></ul><p>Если вы являетесь пользователем balanceofsatoshis, bos упрощает процесс обмена ликвидностью с помощью функции</p><p><em>bos increase-inbound-liquidity &ndash;amount &lt;sats> &ndash;with &lt;pubkey></em></p><p>Имейте в виду, что каждый такой своп обычно занимает час.</p><p>Однако стоит отметить, что нет никаких гарантий, когда речь идет о входящей ликвидности. Контрагенты по каналу всегда могут закрыть канал, если решат, что их капитал распределен не лучшим образом!</p><p>Исключением является Lightning Pool, в котором вы заключаете контракт на покупку ликвидности на определенный срок, и эта продолжительность фактически обеспечивается на уровне блокчейна. Согласно их <a href=https://github.com/lightninglabs/pool-paper/blob/main/liquidity.pdf>whitepaper</a>:</p><p><img src=/img/lln-268.png alt=ln-pool-wp></p><p>Надеюсь, в ближайшем будущем мы также получим встроенные <a href=https://bitcoinops.org/en/newsletters/2021/07/28/#c-lightning-4639>объявления о ликвидности</a>, доступные на уровне протокола.</p><h1 id=lightning-loop>Lightning Loop
<a class=anchor href=#lightning-loop>#</a></h1><p>Я надеялся, что получать входящую ликвидность через сервис Lightning Loop будет проще и безопаснее, чем доверять различным сторонним сервисам. Настроить loopd и использовать loop в командной строке оказалось невероятно просто.</p><p>$ ./loop quote out -v 16777215<br>Send off-chain: 16777215 sat<br>Receive on-chain: 16759995 sat<br>Estimated on-chain fee: 338 sat<br>Loop service fee: 16882 sat<br>Estimated total fee: 17220 sat<br>No show penalty (prepay): 30000 sat</p><p>Похоже, что <a href=https://docs.lightning.engineering/lightning-network-tools/loop/autoloop>Autoloop</a> также должен быть довольно прост в настройке, хотя я не уверен, что он действительно необходим для узла маршрутизации. Я не решаюсь установить автолупинг (autolooping), потому что большинство лупов, производящихся вручную (manual loops), которые я пытаюсь сделать, не завершаются успехом.</p><p>Сложность в создании лупов для получения входящей ликвидности заключается в том, что:</p><ol><li>Это должно быть сделано для довольно большой суммы, чтобы ончейн-комиссия оправдала себя.</li><li>Чем большую сумму вы пытаетесь вывести, тем сложнее найти путь для перенаправления средств оффчейн.</li></ol><p>Подавляющее большинство моих попыток вывести большие объемы потерпели неудачу из-за проблем с lightning-маршрутизацией. Например, мой узел в течение 20 минут пытался найти способ направить 4М сат с узла Blockstream. Я подозреваю, что у них не так много исходящей ликвидности; поскольку это магазин, где большая часть ликвидности, вероятно, направлена в его сторону, как на получателя платежей.</p><h1 id=узел-lightning-loop>Узел Lightning Loop
<a class=anchor href=#%d1%83%d0%b7%d0%b5%d0%bb-lightning-loop>#</a></h1><p>В качестве теста я открыл канал с узлом <a href=https://amboss.space/node/021c97a90a411ff2b10dc2a8e32de2f29d2fa49d41bfbb52bd416e460db0747d0d>LOOP</a>, за что я заплатил 1 sat/b (154 sat) ончейн-комиссии.</p><p>В течение 5 часов по этому каналу было переслано 11 платежей, которые израсходовали 98% моей исходящей емкости на LOOP. Я заработал чуть более 3 000 сатоши в виде комиссии.</p><p>Затем узел LOOP закрыл мой канал с комиссией 2,5 сат/б (244 сат). Предположительно потому, что он был настолько несбалансированным, что у сервера loop не было возможности получить больше средств. Насколько я слышал, у них есть автоматическое закрытие, когда ваш локальный баланс составляет 20% или ниже. Я получил 2,600 сат; звучит довольно неплохо, да?</p><p>LOOP, похоже, перерабатывает тонну каналов; из 48 каналов, открытых на момент написания статьи, их средний возраст составляет 16 дней, и, похоже, он закрывает от 5 до 10% открытых каналов каждый день.</p><p>Далее я попробовал открыть большой канал с LOOP, для которого я установил очень высокую ставку комиссии в 1%, чтобы посмотреть, не клюнет ли кто-нибудь.  </p><p><em>lncli updatechanpolicy &ndash;base_fee_msat 5000 &ndash;fee_rate 0.01 &ndash;time_lock_delta 18 &ndash;chan_point &lt;UTXO></em></p><p>Мне также пришлось обновить конфигурацию &ldquo;charge&rdquo;, чтобы она игнорировала этот канал и не снижала плату автоматически.</p><p>[loop]<br>node.id = 021c97a90a411ff2b10dc2a8e32de2f29d2fa49d41bfbb52bd416e460db0747d0d<br>strategy = ignore</p><p>Через несколько дней, когда не было проведено ни одного платежа, я уменьшил комиссию в два раза и заметил, что платежи стали редко, но поступать. Возможно, позже я попробую повторить этот эксперимент с каналом <a href=https://medium.com/breez-technology/mpps-wumbo-channels-optimizing-liquidity-on-the-lightning-network-6059bedea322>wumbo</a>.</p><p>Однако Алекс Босворт отметил, что это не будет простым циклом открытия каналов с большими объемами “под копирку” с узлом LOOP. Почему? Потому что каждый раз, когда вы это делаете, расходуется общая входящая ликвидность, поступающая в остальную часть сети по всем остальным вашим каналам. Итак, представьте, что у вашего узла в общей сложности 10М сат входящей ликвидности, а вы открываете каналы на 1М с узлом LOOP. Вы сможете повторить это только около 10 раз, прежде чем вы потеряете возможность направлять средства на узел LOOP.</p><p>После достаточного количества экспериментов и неудачных процедур <a href=https://lightning.engineering/loop/>loop out</a>, кажется, что выигрышная стратегия заключается в том, чтобы открыть большой канал с узлом LOOP, установить на нем высокие комиссии за маршрутизацию, чтобы он не истощался, а затем использовать узел для дешевой маршрутизации входящей ликвидности, поскольку вам не придется платить комиссии за маршрутизацию.</p><h1 id=высвобождение-незадействованного-капитала>Высвобождение незадействованного капитала
<a class=anchor href=#%d0%b2%d1%8b%d1%81%d0%b2%d0%be%d0%b1%d0%be%d0%b6%d0%b4%d0%b5%d0%bd%d0%b8%d0%b5-%d0%bd%d0%b5%d0%b7%d0%b0%d0%b4%d0%b5%d0%b9%d1%81%d1%82%d0%b2%d0%be%d0%b2%d0%b0%d0%bd%d0%bd%d0%be%d0%b3%d0%be-%d0%ba%d0%b0%d0%bf%d0%b8%d1%82%d0%b0%d0%bb%d0%b0>#</a></h1><p>Некоторые пиры никогда не маршрутизируют средства, потому что они нестабильны, поэтому я бы закрыл канал с ними — как мне казалось, что держать их открытыми — пустая трата капитала и бесполезное зондирование маршрутов. Но если пир не реагировал, когда я собирался закрыть канал, проводилось принудительное закрытие, в результате чего капитал оставался заблокированным более недели.</p><p>Нет особого смысла в блокировании средств в каналах, если эти средства не используются. К счастью, bos также позволяет довольно легко определить, от каких пиров стоит отказаться.</p><p>bos remove-peer &ndash;dryrun &ndash;idle-days 90 &ndash;fee-rate 5 &ndash;active</p><p>Также имеет место проблема пиров, которые слишком часто находятся оффлайн, что препятствует регулярному перенаправлению средств.</p><p>bos remove-peer &ndash;dryrun &ndash;idle-days 30 &ndash;fee-rate 5 &ndash;offline</p><p>Поскольку эти операции требуют ончейн-транзакций, я собираюсь отнести их к <a href=https://ru.wikipedia.org/wiki/Cron>cron-заданиям</a>, которые будут выполняться в выходные дни, когда комиссии ниже.</p><p>Однако, если вы собираетесь закрыть канал, вы можете попытаться использовать этот капитал для ребалансировки некоторых других каналов.</p><p>Вам также стоит закрыть каналы, которые не приносят вам большого дохода в виде комиссии за маршрутизацию:</p><p>bos peers &ndash;fee-days 60 &ndash;sort fee_earnings</p><p>Результаты этой команды также покажут вам, какие каналы, вероятно, стоит ребалансировать (те, которые приносят много комиссии за маршрутизацию).</p><h1 id=результаты>Результаты
<a class=anchor href=#%d1%80%d0%b5%d0%b7%d1%83%d0%bb%d1%8c%d1%82%d0%b0%d1%82%d1%8b>#</a></h1><p>После того, как я хорошо сбалансировал каналы, я подождал несколько недель, чтобы посмотреть, много ли я заработал на комиссиях.</p><p>$ bos forwards &ndash;complete &ndash;days 90</p><p>На дюжине каналов я заработал 17,025 сатоши в виде комиссии за маршрутизацию.</p><p>$ bos chart-fees-earned</p><p><img src=/img/lln-269.png alt=earned></p><p>Однако я потратил 31,897 сатоши на ончейн-транзакции.</p><p>$ bos chart-chain-fees</p><p><img src=/img/lln-270.png alt=fees></p><p>После еще одного месяца жонглирования моим узлом по выходным, переключения десятков каналов и добавления автоматики:</p><p><img src=/img/lln-271.png alt=earned-fees></p><p>Стоит отметить, что почти половина из 60,000 сатоши, которые были выплачены в качестве ончейн-комиссий, пришлась на <strong>одно принудительное закрытие канала</strong>. Это принудительное закрытие стоило более 100 сатоши за виртуальный байт, в то время как его можно было быстро подтвердить, заплатив около 5 сатоши за виртуальный байт. Оглядываясь назад, я думаю, что этого можно было бы избежать, если бы я был терпелив и подождал, пока этот пир вернется в сеть, прежде чем закрывать канал. Если бы не эта невынужденная ошибка, <em>я, вероятно, заработал бы больше на оффчейн-комиссиях, чем потратил на ончейн-транзакции на сегодняшний день</em>. Похоже, это распространенная проблема.</p><blockquote class=twitter-tweet><p lang=en dir=ltr>I just had a look at my <a href="https://twitter.com/hashtag/LightningNetwork?src=hash&amp;ref_src=twsrc%5Etfw">#LightningNetwork</a> stats. A word of warning:<br><br>Force closes happen, for various reasons. And you might be the one who has to pay. Here's 50,000sat going down the drain: <a href=https://t.co/9BIVySE3zQ>https://t.co/9BIVySE3zQ</a><br>(604269:1446:0)<br><br>Raise your fees, prepare for the worst.</p>&mdash; @c_otto83@toot.bike (@c_otto83) <a href="https://twitter.com/c_otto83/status/1417545255319134213?ref_src=twsrc%5Etfw">July 20, 2021</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>С другой стороны, якорные каналы (anchor channels) должны решить эту проблему, чтобы вам не приходилось полагаться на старые и завышенные комиссионные ставки. Начиная с lnd 0.13.0 вновь созданные каналы используют якоря по умолчанию; вам просто нужно убедиться, что у вас есть ~100,000 сат в своем ончейн-кошельке для использования в качестве комиссионного резерва.</p><p>Что касается оффчейн-комиссий, я рад видеть, что, хотя мои комиссии в ppm теперь ниже, я провожу транзакции более постоянно. За последние 90 дней я собирал в среднем 500 сат в день, а за последние 10 дней — 1,000 сатоши.</p><p>Хотя на момент написания статьи я не являюсь оператором прибыльного узла маршрутизации, я вижу свет в конце тоннеля и буду продолжать свои усилия по анализу и корректировке своего узла.</p><h1 id=мысли-вслух>Мысли вслух
<a class=anchor href=#%d0%bc%d1%8b%d1%81%d0%bb%d0%b8-%d0%b2%d1%81%d0%bb%d1%83%d1%85>#</a></h1><p>До обновления до lnd v0.13 мой (исключительно Tor) узел не мог подключаться к узлам IPV4, что значительно ограничивало мои возможности по развертыванию капитала. Если вы используете узел, работающий только через Tor, вы должны понимать, что вы будете в невыгодном положении, когда дело дойдет до получения входящей ликвидности от узлов, не работающих на Tor.</p><blockquote class=twitter-tweet><p lang=en dir=ltr>Unpopular Truth<br>Tor unfortunately makes LN too unreliable. During the best of times it causes routing to go a lot slower. During the worst of times routing stops working entirely. RPC ping with larger data reveals the response time stretching into tens of seconds which breaks LN.</p>&mdash; Warren Togami (@wtogami) <a href="https://twitter.com/wtogami/status/1405785148298338308?ref_src=twsrc%5Etfw">June 18, 2021</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>Как оператор, вы должны ориентироваться не только на балансы отдельных каналов, но и на общее соотношение входящей и исходящей ликвидности вашего узла. Например, если у вас 100М сат исходящей ликвидности, но только 10М сат входящей, большая часть этой исходящей ликвидности бесполезна. Получение входящей ликвидности — одна из самых больших проблем, с которой я столкнулся, даже после выполнения множества <em>loop out</em>’ов.</p><p>Код алгоритма Lightning Terminal Web закрыт; трудно сказать, сколько средств можно ему доверить. Кроме того, он будет считать ваш узел нестабильным, если время его безотказной работы будет ниже 99,9% — с этой точки зрения, <strong>запуск узла маршрутизации через домашнее интернет-подключение без регулярного резервного копирования вряд-ли является лучшей идеей</strong>. Забавно, но я заметил проблемы с надежностью у некоторых случайных пользователей, с которыми я переписывался в Telegram-группах, которые запускали свои узлы на Raspberry Pi дома. Исходя из моего личного опыта эксплуатации узлов Raspberry Pi дома в течение многих лет, я бы посоветовал купить мощный ИБП и подключить к нему модем, маршрутизатор и узел. И ничего больше. Поскольку все эти устройства потребляют довольно мало энергии, используя достойный ИБП, вы сможете поддерживать узел в режиме онлайн более часа, а то и дольше.</p><p>Если вы хотите попытаться улучшить свой показатель Lightning Terminal, ознакомьтесь с данным инструментом, который проводит обратную инженерию: <a href=https://lnrouter.app/scores/terminal>https://lnrouter.app/scores/terminal</a>.</p><p>Запуск других служб на вашем узле может быть проблематичным. Несмотря на то, что мой узел был мощным (16 ядер и 16 ГБ оперативной памяти), я заметил, что когда я запускал на нем сервер electrum и нагрузка на оборудование в среднем превышала 1,0, Lightning Terminal начинал сообщать, что мой узел &ldquo;нестабилен&rdquo;.</p><p>Работа узла маршрутизации и поиск потоков ликвидности похожи на глубоководную рыбалку. Вы знаете, что рыба где-то там, но вы не можете ее увидеть. Вам приходится постоянно забрасывать лески и сети, чтобы понять, где находятся потоки средств, к которым вы можете подключиться.</p><blockquote class=twitter-tweet><p lang=en dir=ltr>It can be hard to tell when you lose inbound liquidity on LN. Imagine you open a nice big channel to someone who has no inbound themselves. Then you route tons of sats there, great! You have inbound from them now, but they have no inbound, so now you have no more inbound. Sorry!</p>&mdash; Alex Bosworth (@alexbosworth) <a href="https://twitter.com/alexbosworth/status/1412788505818931200?ref_src=twsrc%5Etfw">July 7, 2021</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>Максимальный размер не-wumbo канала составляет 16.7М сат. По моему опыту, попытки маршрутизации платежей размером более 4M сат обычно вызывают проблемы. Помните, что по умолчанию максимальное значение одиночного платежа составляет чуть более 4М сат. Даже если ограничение на величину платежа будет снято, и все каналы будут идеально сбалансированы и иметь максимальную емкость, это поднимет максимальный возможный платеж до 8.3М сат.</p><p>Доктор Карстен Отто имеет массу полезных заметок на своем веб-сайте <a href=https://c-otto.de/>https://c-otto.de/</a>.</p><h1 id=что-дальше>Что дальше?
<a class=anchor href=#%d1%87%d1%82%d0%be-%d0%b4%d0%b0%d0%bb%d1%8c%d1%88%d0%b5>#</a></h1><p>Существует еще много возможностей для совершенствования инструментов, которые помогают операторам узла Lightning лучше понять управление ликвидностью и маршрутизацию.</p><p>Хотелось бы видеть более наглядные визуализации каналов, по которым пересылаются платежи. <a href=https://www.thunderhub.io/>Thunderhub</a>, например, может создавать струнные диаграммы, чтобы визуализировать эту активность; я надеюсь, что больше программного обеспечения для панелей управления Lightning начнет делать это автоматически.</p><p><img src=/img/lln-272.png alt=thunderhub></p><p>Было бы здорово, если бы вы могли легко отправлять сообщения операторам узлов-ровесников, чтобы спросить, как дела, или узнать их намерения. Теоретически вы можете использовать keysend для отправки им платежа в 1 сатоши со встроенным сообщением, но нет никакой гарантии, что оператор узла когда-либо увидит его. Для этого можно использовать &ldquo;bos send&rdquo;.</p><p>bos send &ndash;message=&ldquo;hey what&rsquo;s up?&rdquo;</p><p>С отправкой сообщений есть небольшая проблема. Операторы узлов могут не замечать их, потому что они не используют Thunderhub или не настроили канал Telegram для отправки сообщений bos, поэтому другие операторы узлов не утруждают себя отправкой сообщений, так как они могут быть пропущены.</p><p>Рене Пикардт и Стефан Рихтер опубликовали работу, в которой показали, что поиск оптимальных маршрутов значительно усложняется, если базовая плата не установлена на 0: <a href=https://arxiv.org/abs/2107.05322>https://arxiv.org/abs/2107.05322</a></p><p>Я видел множество операторов, устанавливающих базовую плату своей ноды на 0, но я подозреваю, что это ошибочное решение, которое практически ничего не улучшит на момент написания статьи — это теоретическая оптимизация, от которой ноды начнут получать выгоду, только если разработчики действительно реализуют алгоритм нахождения пути, предложенный Рене и Стефаном.</p><p>Кроме того, в статье не обсуждаются другие компромиссы, такие как введение векторов DoS. Подумайте, что когда ваш узел принимает HTLC для маршрутизации сат, узел должен сохранять данные, связанные с этим HTLC, в своей базе данных. Таким образом, если ваша базовая комиссия равна 0, то кто-то может направить миллионы миллисатоши через ваш узел, не заплатив за это высокую цену. Однако, в грандиозной схеме потенциальных атак это может быть мелочью по сравнению с другими известными проблемами, такими как <a href=https://bitcoinmagazine.com/technical/good-griefing-a-lingering-vulnerability-on-lightning-network-that-still-needs-fixing>griefing</a> и <a href=https://lists.linuxfoundation.org/pipermail/lightning-dev/2020-June/002735.html>вымогательство</a>, которые позволяют злоумышленнику бесплатно заблокировать много средств.</p><p>Также было бы здорово, если бы кто-нибудь создал инструмент для визуализации входящей/исходящей ликвидности вашего узла и входящей/исходящей ликвидности всех узлов-аналогов. Это несколько сложно выяснить (в силу самого дизайна сети Lightning), но, возможно, есть способ приблизительно оценить эти показатели с помощью тщательно построенного зондирования маршрута.</p><p>Если вы дочитали это эссе до конца, поздравляем! Надеюсь, теперь вам ясно, что Lightning Network — это целый новый мир, который нам предстоит не только изучить, но и построить.</p><p>Спасибо <a href=https://twitter.com/alexbosworth>Алексу Босворту</a>, <a href=https://twitter.com/ErinEMalone>Эрин Мэлоун</a> и доктору <a href=https://twitter.com/c_otto83>Карстену Отто</a> за рецензии и отзывы.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#уроки-полученные-при-управлении-узлом-маршрутизации-в-сети-lightning>Уроки, полученные при управлении узлом маршрутизации в сети Lightning.</a></li></ul></li><li><a href=#ваша-прибыль-может-варьироваться>Ваша прибыль может варьироваться</a></li><li><a href=#множество-переменных>Множество переменных</a></li><li><a href=#принятие-решения-по-открытию-каналов>Принятие решения по открытию каналов</a></li><li><a href=#экономия-на-ончейн-комиссиях-за-открытие-канала-с-помощью-сгруппированных-открытий-batch-opens>Экономия на ончейн-комиссиях за открытие канала с помощью сгруппированных открытий (Batch Opens)</a></li><li><a href=#открытие-каналов-с-взаимным-финансированием>Открытие каналов с взаимным финансированием</a></li><li><a href=#ребалансировка-каналов>Ребалансировка каналов</a></li><li><a href=#управление-политикой-канала>Управление политикой канала</a></li><li><a href=#покупка-входящей-ликвидности>Покупка входящей ликвидности</a></li><li><a href=#lightning-loop>Lightning Loop</a></li><li><a href=#узел-lightning-loop>Узел Lightning Loop</a></li><li><a href=#высвобождение-незадействованного-капитала>Высвобождение незадействованного капитала</a></li><li><a href=#результаты>Результаты</a></li><li><a href=#мысли-вслух>Мысли вслух</a></li><li><a href=#что-дальше>Что дальше?</a></li></ul></nav></div></aside></main></body></html>